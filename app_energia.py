# -*- coding: utf-8 -*-
"""Aplicaci√≥n de An√°lisis Energ√©tico Pro

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1-BPS6peeXk4N0wdHW-afnQEOq-KoP0cL
"""

import streamlit as st
import pandas as pd
import plotly.express as px
import requests
import json
from datetime import datetime

# --- CONFIGURACI√ìN DE P√ÅGINA ---
st.set_page_config(
    page_title="IA Energy Consultant Pro",
    page_icon="‚ö°",
    layout="wide",
)

# --- ESTILOS PERSONALIZADOS ---
st.markdown("""
    <style>
    .report-container {
        background-color: white;
        padding: 40px;
        border-radius: 15px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        max-width: 1000px;
        margin: auto;
    }
    .stMetric {
        background-color: #f8fafc;
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #e2e8f0;
    }
    .prompt-box {
        background-color: #f1f5f9;
        padding: 15px;
        border-left: 5px solid #1e40af;
        border-radius: 5px;
        font-family: monospace;
        font-size: 0.9em;
    }
    </style>
""", unsafe_allow_html=True)

# --- MAPEOS DE IDIOMA Y ORDEN ---
DIAS_ORDENADOS = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo']
MESES_ORDENADOS = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre']

DIAS_MAP = {
    'Monday': 'Lunes', 'Tuesday': 'Martes', 'Wednesday': 'Mi√©rcoles',
    'Thursday': 'Jueves', 'Friday': 'Viernes', 'Saturday': 'S√°bado', 'Sunday': 'Domingo'
}
MESES_MAP = {
    'January': 'Enero', 'February': 'Febrero', 'March': 'Marzo', 'April': 'Abril',
    'May': 'Mayo', 'June': 'Junio', 'July': 'Julio', 'August': 'Agosto',
    'September': 'Septiembre', 'October': 'Octubre', 'November': 'Noviembre', 'December': 'Diciembre'
}

# --- PROCESAMIENTO DE DATOS ---
@st.cache_data
def procesar_archivo(uploaded_file):
    try:
        if uploaded_file.name.endswith('.csv'):
            for encoding in ['utf-8', 'latin-1', 'iso-8859-1', 'cp1252']:
                try:
                    uploaded_file.seek(0)
                    df = pd.read_csv(uploaded_file, sep=None, engine='python', encoding=encoding)
                    break
                except UnicodeDecodeError:
                    continue
        else:
            try:
                df = pd.read_excel(uploaded_file, sheet_name="TABLA HORARIA")
            except:
                df = pd.read_excel(uploaded_file)

        df.columns = df.columns.astype(str).str.strip()
        df = df.dropna(how='all', axis=0)

        # Normalizar nombres a min√∫sculas
        cols_originales = list(df.columns)
        col_fecha_orig = next((c for c in cols_originales if c.lower() == 'fecha'), None)

        if col_fecha_orig:
            # Detectar formato H1...H24
            value_vars = [c for c in cols_originales if c.upper().startswith('H') and any(char.isdigit() for char in c)]
            id_vars = [c for c in cols_originales if c not in value_vars]

            if value_vars:
                df = df.melt(id_vars=id_vars, value_vars=value_vars, var_name='Hora_Raw', value_name='Energia_Melted')

            df.columns = [c.lower() for c in df.columns]
            terminos_busqueda = ['energia', 'kwh', 'consumo', 'valor', 'active', 'total']
            col_kwh = 'energia_melted' if 'energia_melted' in df.columns else next((c for term in terminos_busqueda for c in df.columns if term in c), None)

            if col_kwh:
                df = df.rename(columns={col_kwh: 'kwh', col_fecha_orig.lower(): 'fecha'})
                df['fecha_dt'] = pd.to_datetime(df['fecha'], errors='coerce')
                df['kwh'] = pd.to_numeric(df['kwh'], errors='coerce').fillna(0)
                df = df.dropna(subset=['fecha_dt'])

                # Extraer hora
                if 'hora_raw' in df.columns:
                    df['hora_num'] = pd.to_numeric(df['hora_raw'].astype(str).str.extract('(\d+)')[0], errors='coerce').fillna(0).astype(int)
                else:
                    df['hora_num'] = df['fecha_dt'].dt.hour

                df['dia_nombre'] = df['fecha_dt'].dt.day_name().map(DIAS_MAP)
                df['mes_nombre'] = df['fecha_dt'].dt.month_name().map(MESES_MAP)

                # Clasificaci√≥n de Tarifa Corregida
                def categorizar_tarifa(h):
                    if 18 <= h <= 22: return 'Alta (Punta)'
                    elif (8 <= h <= 17) or (h == 23): return 'Media (Valle)'
                    else: return 'Baja (Super Valle)'

                df['tarifa'] = df['hora_num'].apply(categorizar_tarifa)

                # Costos Simbolicos
                precios = {'Alta (Punta)': 0.45, 'Media (Valle)': 0.25, 'Baja (Super Valle)': 0.15}
                df['costo_total'] = df.apply(lambda row: row['kwh'] * precios.get(row['tarifa'], 0.20), axis=1)

                return df
        return None
    except Exception as e:
        st.error(f"Error: {e}")
        return None

# --- LOGIN ---
def gestionar_login():
    if "auth_state" not in st.session_state: st.session_state.auth_state = False
    if not st.session_state.auth_state:
        st.title("üîê Acceso Energy BI")
        u = st.text_input("Usuario")
        p = st.text_input("Contrase√±a", type="password")
        if st.button("Ingresar"):
            if u == "admin" and p == "admin123":
                st.session_state.auth_state = True
                st.session_state.user_role = "Administrador"
                st.session_state.user_name = "Admin"
                st.rerun()
        return False
    return True

# --- UI PRINCIPAL ---
if gestionar_login():
    # Sidebar
    st.sidebar.title("Configuraci√≥n")
    nombre_consultor = st.sidebar.text_input("Consultor", "Juan P√©rez")
    cargo_consultor = st.sidebar.text_input("Cargo", "Especialista Energ√©tico")
    logo_file = st.sidebar.file_uploader("Logo Empresa", type=["png", "jpg"])

    if st.session_state.user_role == "Administrador":
        up_file = st.sidebar.file_uploader("Cargar Datos", type=["csv", "xlsx"])
        if up_file:
            data = procesar_archivo(up_file)
            if data is not None: st.session_state.df_master = data

    if "df_master" in st.session_state:
        df = st.session_state.df_master

        # FILTRO POR NOMBRE (CLIENTE)
        col_nombre = next((c for c in df.columns if 'nombre' in c or 'cliente' in c), None)
        if col_nombre:
            clientes = ["Todos"] + sorted(list(df[col_nombre].unique()))
            cliente_sel = st.sidebar.selectbox("Filtrar por Cliente/Sede", clientes)
            df_view = df if cliente_sel == "Todos" else df[df[col_nombre] == cliente_sel]
        else:
            df_view = df
            st.sidebar.warning("Columna 'Nombre' no detectada.")

        t1, t2, t3, t4 = st.tabs(["üìä An√°lisis Principal", "üî¨ Explorador Libre", "üß† Prompt de IA", "üìÑ Informe Final"])

        with t1:
            st.subheader(f"Dashboard de Consumo - {cliente_sel if col_nombre else 'General'}")
            c1, c2 = st.columns(2)

            # Gr√°fico Horas
            df_h = df_view.groupby('hora_num')['kwh'].mean().reset_index()
            fig_h = px.line(df_h, x='hora_num', y='kwh', title="Curva Horaria Promedio", markers=True)
            c1.plotly_chart(fig_h, use_container_width=True)

            # Gr√°fico D√≠as (Ordenado)
            df_d = df_view.groupby('dia_nombre')['kwh'].sum().reset_index()
            fig_d = px.bar(df_d, x='dia_nombre', y='kwh', title="Consumo por D√≠a", category_orders={"dia_nombre": DIAS_ORDENADOS})
            c2.plotly_chart(fig_d, use_container_width=True)

            # Gr√°fico Meses (Ordenado)
            df_m = df_view.groupby('mes_nombre')['kwh'].sum().reset_index()
            fig_m = px.bar(df_m, x='mes_nombre', y='kwh', title="Consumo por Mes", category_orders={"mes_nombre": MESES_ORDENADOS})
            st.plotly_chart(fig_m, use_container_width=True)

        with t2:
            st.subheader("Laboratorio de Datos")
            col_x, col_y, col_tipo = st.columns(3)
            with col_x: sx = st.selectbox("Eje X", ["hora_num", "dia_nombre", "mes_nombre", "tarifa"])
            with col_y: sy = st.selectbox("Eje Y", ["kwh", "costo_total"])
            with col_tipo: stp = st.selectbox("Gr√°fico", ["Barras", "L√≠neas", "Pastel", "√Årea"])

            df_lab = df_view.groupby(sx)[sy].sum().reset_index()
            # Ordenamiento para el laboratorio
            cat_orders = {"dia_nombre": DIAS_ORDENADOS, "mes_nombre": MESES_ORDENADOS}

            if stp == "Barras": fig_lab = px.bar(df_lab, x=sx, y=sy, color=sx, category_orders=cat_orders)
            elif stp == "L√≠neas": fig_lab = px.line(df_lab, x=sx, y=sy, markers=True, category_orders=cat_orders)
            elif stp == "Pastel": fig_lab = px.pie(df_lab, names=sx, values=sy)
            else: fig_lab = px.area(df_lab, x=sx, y=sy, category_orders=cat_orders)

            st.plotly_chart(fig_lab, use_container_width=True)

            if st.button("üìå Agregar esta gr√°fica al Informe Final"):
                if "pinned_charts" not in st.session_state: st.session_state.pinned_charts = []
                st.session_state.pinned_charts.append(fig_lab)
                st.success("Gr√°fica guardada en el informe.")

        with t3:
            st.subheader("Generador de Prompt para Auditor√≠a Externa")
            st.write("Copia este prompt y p√©galo en tu IA favorita (ChatGPT, Gemini, Claude) para obtener un an√°lisis profundo.")

            # C√°lculo de variables para el prompt
            total_kwh = df_view['kwh'].sum()
            punta_pct = (df_view[df_view['tarifa'] == 'Alta (Punta)']['kwh'].sum() / total_kwh) * 100
            valle_pct = (df_view[df_view['tarifa'] == 'Media (Valle)']['kwh'].sum() / total_kwh) * 100
            dia_max = df_view.groupby('dia_nombre')['kwh'].sum().idxmax()
            hora_pico = df_view.groupby('hora_num')['kwh'].mean().idxmax()

            prompt_text = f"""
            Act√∫a como un Auditor Energ√©tico Senior Certificado. Analiza el siguiente perfil de consumo para el cliente {cliente_sel}:

            DATOS T√âCNICOS:
            - Consumo Total: {total_kwh:,.2f} kWh
            - Distribuci√≥n Tarifaria: Punta ({punta_pct:.1f}%), Valle ({valle_pct:.1f}%), Super Valle ({100-punta_pct-valle_pct:.1f}%)
            - D√≠a de mayor carga: {dia_max}
            - Hora de m√°xima demanda promedio: {hora_pico}:00 hrs

            CONDICIONES:
            1. El costo en horario PUNTA es 3 veces mayor al Super Valle.
            2. Identifica si existe consumo base (stand-by) excesivo en horas de madrugada (00:00 - 05:00).
            3. Analiza la variabilidad entre d√≠as de semana y fines de semana.

            REQUERIMIENTO:
            Dame un informe de 3 p√°rrafos:
            - P√°rrafo 1: Hallazgos cr√≠ticos del comportamiento.
            - P√°rrafo 2: 3 Acciones inmediatas de eficiencia operativa (sin inversi√≥n).
            - P√°rrafo 3: Justificaci√≥n financiera para un sistema de almacenamiento o desplazamiento de carga.
            """

            st.markdown(f'<div class="prompt-box">{prompt_text}</div>', unsafe_allow_html=True)
            st.button("üìã Copiar Prompt (Simulado)")

        with t4:
            st.subheader("Vista Previa del Informe Final")
            with st.container():
                st.markdown('<div class="report-container">', unsafe_allow_html=True)
                c_l, c_r = st.columns([1, 2])
                with c_l:
                    if logo_file: st.image(logo_file, width=150)
                with c_r:
                    st.markdown(f"<h1 style='text-align:right; color:#1e40af;'>REPORTE ENERG√âTICO PROFESIONAL</h1>", unsafe_allow_html=True)
                    st.markdown(f"<p style='text-align:right;'>Cliente: <b>{cliente_sel}</b> | {datetime.now().strftime('%d/%m/%Y')}</p>", unsafe_allow_html=True)

                st.divider()
                st.markdown("### 1. Resumen Ejecutivo")
                m1, m2, m3 = st.columns(3)
                m1.metric("Consumo Total", f"{df_view['kwh'].sum():,.2f} kWh")
                m2.metric("Costo Estimado", f"${df_view['costo_total'].sum():,.2f}")
                m3.metric("Tarifa Dominante", df_view.groupby('tarifa')['kwh'].sum().idxmax())

                st.markdown("### 2. An√°lisis Visual")
                st.plotly_chart(fig_h, use_container_width=True) # Siempre incluimos la curva horaria

                # Gr√°ficas ancladas
                if "pinned_charts" in st.session_state:
                    for i, p_fig in enumerate(st.session_state.pinned_charts):
                        st.plotly_chart(p_fig, use_container_width=True)

                st.markdown("---")
                st.markdown(f"<p><b>Consultor:</b> {nombre_consultor}<br><i>{cargo_consultor}</i></p>", unsafe_allow_html=True)
                st.markdown('</div>', unsafe_allow_html=True)

            if st.button("üóëÔ∏è Limpiar gr√°ficas del informe"):
                st.session_state.pinned_charts = []
                st.rerun()

    else:
        st.info("Cargue un archivo para comenzar el an√°lisis.")