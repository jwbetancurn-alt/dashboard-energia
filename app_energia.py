# -*- coding: utf-8 -*-
"""Aplicaci√≥n de An√°lisis Energ√©tico Pro

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1rrD8ul3Z7y_Gp_0ZUtROMRxC8FFz4C3Y
"""

import streamlit as st
import pandas as pd
import plotly.express as px
import requests
import json
import time
from datetime import datetime

# --- CONFIGURACI√ìN DE P√ÅGINA ---
st.set_page_config(
    page_title="IA Energy Consultant Pro",
    page_icon="‚ö°",
    layout="wide",
)

# --- ESTILOS PERSONALIZADOS ---
st.markdown("""
    <style>
    .report-container {
        background-color: white;
        padding: 40px;
        border-radius: 15px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        max-width: 1000px;
        margin: auto;
    }
    .stMetric {
        background-color: #f8fafc;
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #e2e8f0;
    }
    .consultant-info {
        margin-top: 40px;
        border-top: 2px solid #f1f5f9;
        padding-top: 20px;
    }
    </style>
""", unsafe_allow_html=True)

# --- MAPEOS DE IDIOMA ---
DIAS_ORDENADOS = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo']
DIAS_MAP = {
    'Monday': 'Lunes', 'Tuesday': 'Martes', 'Wednesday': 'Mi√©rcoles',
    'Thursday': 'Jueves', 'Friday': 'Viernes', 'Saturday': 'S√°bado', 'Sunday': 'Domingo'
}
MESES_MAP = {
    'January': 'Enero', 'February': 'Febrero', 'March': 'Marzo', 'April': 'Abril',
    'May': 'Mayo', 'June': 'Junio', 'July': 'Julio', 'August': 'Agosto',
    'September': 'Septiembre', 'October': 'Octubre', 'November': 'Noviembre', 'December': 'Diciembre'
}

# --- CONSTANTES Y API (CON REINTENTOS) ---
API_KEY = "" # El entorno proporciona la clave autom√°ticamente

def llamar_ia_gemini(prompt):
    url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key={API_KEY}"
    payload = {
        "contents": [{"parts": [{"text": prompt}]}],
        "systemInstruction": {"parts": [{"text": "Eres un consultor energ√©tico senior. Proporciona an√°lisis t√©cnicos breves, acciones de ahorro y conclusiones basadas en datos."}]}
    }

    # Implementaci√≥n de reintentos con Exponential Backoff
    for i in range(5):
        try:
            response = requests.post(url, json=payload, timeout=20)
            if response.status_code == 200:
                result = response.json()
                return result['candidates'][0]['content']['parts'][0]['text']
            time.sleep(2**i)
        except Exception:
            time.sleep(2**i)

    return "No se pudo conectar con el servicio de IA tras varios intentos. Por favor, revisa tu conexi√≥n o intenta m√°s tarde."

# --- PROCESAMIENTO DE DATOS ---
@st.cache_data
def procesar_archivo(uploaded_file):
    try:
        if uploaded_file.name.endswith('.csv'):
            for encoding in ['utf-8', 'latin-1', 'iso-8859-1', 'cp1252']:
                try:
                    uploaded_file.seek(0)
                    df = pd.read_csv(uploaded_file, sep=None, engine='python', encoding=encoding)
                    break
                except UnicodeDecodeError:
                    continue
        else:
            try:
                df = pd.read_excel(uploaded_file, sheet_name="TABLA HORARIA")
            except:
                df = pd.read_excel(uploaded_file)

        df.columns = df.columns.astype(str).str.strip()
        df = df.dropna(how='all', axis=0)
        cols_originales = list(df.columns)
        col_fecha_orig = next((c for c in cols_originales if c.lower() == 'fecha'), None)

        if col_fecha_orig:
            value_vars = [c for c in cols_originales if c.upper().startswith('H') and any(char.isdigit() for char in c)]
            id_vars = [c for c in cols_originales if c not in value_vars]

            if value_vars:
                df = df.melt(id_vars=id_vars, value_vars=value_vars, var_name='Hora_Raw', value_name='Energia_Melted')

            df.columns = [c.lower() for c in df.columns]
            terminos_busqueda = ['energia', 'kwh', 'consumo', 'valor', 'active', 'energy', 'total']
            col_kwh = 'energia_melted' if 'energia_melted' in df.columns else next((c for term in terminos_busqueda for c in df.columns if term in c), None)

            if col_kwh:
                df = df.rename(columns={col_kwh: 'kwh', col_fecha_orig.lower(): 'fecha'})
                df['fecha_dt'] = pd.to_datetime(df['fecha'], errors='coerce')
                df['kwh'] = pd.to_numeric(df['kwh'], errors='coerce').fillna(0)
                df = df.dropna(subset=['fecha_dt'])

                # Extraer hora correctamente
                if 'hora_raw' in df.columns:
                    df['hora_num'] = pd.to_numeric(df['hora_raw'].astype(str).str.extract('(\d+)')[0], errors='coerce').fillna(0).astype(int)
                else:
                    df['hora_num'] = df['fecha_dt'].dt.hour

                df['dia_nombre'] = df['fecha_dt'].dt.day_name().map(DIAS_MAP)
                df['mes_nombre'] = df['fecha_dt'].dt.month_name().map(MESES_MAP)

                # ACTUALIZACI√ìN DE L√ìGICA DE TARIFAS
                def categorizar_tarifa(h):
                    # Definici√≥n est√°ndar: Punta (13-18), Valle (7-12, 19-22), S.Valle (23-6)
                    if 13 <= h <= 18: return 'Alta (Punta)'
                    elif (7 <= h <= 12) or (19 <= h <= 22): return 'Media (Valle)'
                    else: return 'Baja (Super Valle)'

                df['tarifa'] = df['hora_num'].apply(categorizar_tarifa)

                # Costo diferenciado por tarifa
                precios = {'Alta (Punta)': 0.35, 'Media (Valle)': 0.22, 'Baja (Super Valle)': 0.12}
                df['costo_total'] = df.apply(lambda row: row['kwh'] * precios.get(row['tarifa'], 0.20), axis=1)

                return df
            else:
                st.error("No se detect√≥ columna de consumo.")
        return None
    except Exception as e:
        st.error(f"Error en procesamiento: {e}")
        return None

# --- LOGIN ---
def gestionar_login():
    if "auth_state" not in st.session_state: st.session_state.auth_state = False
    if not st.session_state.auth_state:
        st.title("üîê Acceso Energy BI")
        u = st.text_input("Usuario")
        p = st.text_input("Contrase√±a", type="password")
        if st.button("Ingresar"):
            if u == "admin" and p == "admin123":
                st.session_state.auth_state = True
                st.session_state.user_role = "Administrador"
                st.session_state.user_name = "Administrador"
                st.rerun()
            else: st.error("Error de acceso")
        return False
    return True

# --- UI PRINCIPAL ---
if gestionar_login():
    # Sidebar
    st.sidebar.title(f"Sesi√≥n: {st.session_state.user_name}")
    if st.sidebar.button("Cerrar Sesi√≥n"):
        st.session_state.auth_state = False
        st.rerun()

    st.sidebar.divider()
    logo_file = st.sidebar.file_uploader("Subir Logo", type=["png", "jpg", "jpeg"])
    nombre_cliente = st.sidebar.text_input("Cliente", "Empresa Ejemplo S.A.")
    nombre_consultor = st.sidebar.text_input("Consultor", "Juan P√©rez")
    cargo_consultor = st.sidebar.text_input("Cargo", "Director de Proyectos")
    mes_informe_sel = st.sidebar.selectbox("Mes de Informe", list(MESES_MAP.values()), index=datetime.now().month-1)

    if st.session_state.user_role == "Administrador":
        up_file = st.sidebar.file_uploader("Archivo (CSV/XLSX)", type=["csv", "xlsx"])
        if up_file:
            data = procesar_archivo(up_file)
            if data is not None: st.session_state.df_master = data

    if "df_master" in st.session_state:
        df = st.session_state.df_master

        t1, t2, t3, t4 = st.tabs(["üìä An√°lisis Principal", "üî¨ Explorador Libre", "üí° Estrategia IA", "üìÑ Informe Final"])

        with t1:
            st.subheader("An√°lisis de Demanda y Costos")
            # Gr√°ficos por Hora, D√≠a y Mes
            c1, c2 = st.columns(2)

            with c1:
                # Por Horas
                df_hora = df.groupby('hora_num')['kwh'].mean().reset_index()
                st.plotly_chart(px.line(df_hora, x='hora_num', y='kwh', title="Curva de Carga Promedio (H)", labels={'kwh': 'kWh Promedio'}), use_container_width=True)

                # Por Tarifas (Corregido)
                df_tarifa = df.groupby('tarifa')['kwh'].sum().reset_index()
                st.plotly_chart(px.pie(df_tarifa, names='tarifa', values='kwh', title="Distribuci√≥n por Tipo de Tarifa", hole=0.4), use_container_width=True)

            with c2:
                # Por D√≠as
                df_dia = df.groupby('dia_nombre')['kwh'].sum().reset_index()
                st.plotly_chart(px.bar(df_dia, x='dia_nombre', y='kwh', title="Consumo por D√≠a de la Semana", category_orders={"dia_nombre": DIAS_ORDENADOS}), use_container_width=True)

                # Por Meses
                df_mes = df.groupby('mes_nombre')['kwh'].sum().reset_index()
                st.plotly_chart(px.bar(df_mes, x='mes_nombre', y='kwh', title="Hist√≥rico por Mes"), use_container_width=True)

        with t2:
            st.subheader("Laboratorio de Datos Avanzado")
            col_x, col_y, col_tipo = st.columns(3)
            with col_x: sel_x = st.selectbox("Dimensi√≥n (X)", ["hora_num", "dia_nombre", "mes_nombre", "tarifa"])
            with col_y: sel_y = st.selectbox("M√©trica (Y)", ["kwh", "costo_total"])
            with col_tipo: sel_tipo = st.selectbox("Tipo de Gr√°fico", ["Barras", "L√≠neas", "√Årea", "Pastel"])

            df_lab = df.groupby(sel_x)[sel_y].sum().reset_index()
            if sel_tipo == "Barras": fig = px.bar(df_lab, x=sel_x, y=sel_y, color=sel_x)
            elif sel_tipo == "L√≠neas": fig = px.line(df_lab, x=sel_x, y=sel_y, markers=True)
            elif sel_tipo == "√Årea": fig = px.area(df_lab, x=sel_x, y=sel_y)
            else: fig = px.pie(df_lab, names=sel_x, values=sel_y)

            st.plotly_chart(fig, use_container_width=True)

        with t3:
            st.subheader("Consultor√≠a de Inteligencia Artificial")
            c_ia1, c_ia2 = st.columns([1, 2])
            with c_ia1:
                st.write("Configuraci√≥n de Simulaci√≥n")
                p_shift = st.slider("% Energ√≠a a desplazar de Punta", 0, 100, 30)
                # C√°lculo de ahorro
                punta_vals = df[df['tarifa'] == 'Alta (Punta)']
                ahorro_potencial = punta_vals['kwh'].sum() * (p_shift/100) * 0.15
                st.metric("Ahorro Estimado", f"${ahorro_potencial:,.2f}")

            with c_ia2:
                if st.button("üöÄ Generar Informe de Auditor√≠a IA"):
                    with st.spinner("Analizando patrones de consumo..."):
                        consumo_total = df['kwh'].sum()
                        tarifa_predominante = df.groupby('tarifa')['kwh'].sum().idxmax()
                        prompt = (f"Cliente: {nombre_cliente}. Consumo total: {consumo_total:,.2f} kWh. "
                                 f"Tarifa m√°s usada: {tarifa_predominante}. Mes: {mes_informe_sel}. "
                                 f"Ahorro potencial desplazando {p_shift}% de carga punta: ${ahorro_potencial:,.2f}. "
                                 "Dame 3 acciones t√©cnicas de ahorro energ√©tico.")
                        st.session_state.ia_result = llamar_ia_gemini(prompt)

                if "ia_result" in st.session_state:
                    st.markdown("### Recomendaciones del Consultor IA")
                    st.info(st.session_state.ia_result)

        with t4:
            st.subheader("Vista Previa del Informe")
            with st.container():
                st.markdown('<div class="report-container">', unsafe_allow_html=True)
                r_col1, r_col2 = st.columns([1, 2])
                with r_col1:
                    if logo_file: st.image(logo_file, width=150)
                    else: st.markdown("### [LOGO]")
                with r_col2:
                    st.markdown(f"<h1 style='text-align:right; color:#1e40af;'>INFORME DE GESTI√ìN ENERG√âTICA</h1>", unsafe_allow_html=True)
                    st.markdown(f"<p style='text-align:right;'><b>Mes:</b> {mes_informe_sel} | <b>Emisi√≥n:</b> {datetime.now().strftime('%d/%m/%Y')}</p>", unsafe_allow_html=True)

                st.divider()
                st.write(f"**Cliente:** {nombre_cliente}")

                m1, m2, m3 = st.columns(3)
                m1.metric("Consumo Total", f"{df['kwh'].sum():,.2f} kWh")
                m2.metric("Costo Estimado", f"${df['costo_total'].sum():,.2f}")
                m3.metric("Tarifa Cr√≠tica", df.groupby('tarifa')['kwh'].sum().idxmax())

                st.markdown("#### An√°lisis y Recomendaciones")
                st.write(st.session_state.get("ia_result", "An√°lisis IA no generado a√∫n."))

                st.markdown(f"""
                <div class="consultant-info">
                    <p style='margin-bottom:0;'>__________________________</p>
                    <p style='margin-bottom:0;'><b>{nombre_consultor}</b></p>
                    <p style='color:gray;'>{cargo_consultor}</p>
                </div>
                """, unsafe_allow_html=True)
                st.markdown('</div>', unsafe_allow_html=True)
            st.caption("Tip: Usa Ctrl+P para guardar este informe como PDF.")
    else:
        st.info("üëã Bienvenido. Cargue un archivo CSV o Excel en el panel lateral para comenzar.")