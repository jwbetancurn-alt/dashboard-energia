# -*- coding: utf-8 -*-
"""Aplicaci√≥n de Consultor√≠a Energ√©tica Avanzada

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1eZP8PAmy_dLCzWC1KHaEcOGBWAlqAeIM
"""

import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
import numpy as np
from datetime import datetime

# --- CONFIGURACI√ìN DE P√ÅGINA ---
st.set_page_config(
    page_title="Consultor√≠a Energ√©tica Expert BI",
    page_icon="‚ö°",
    layout="wide",
)

# --- ESTILOS DE INGENIER√çA ---
st.markdown("""
    <style>
    .report-container {
        background-color: white; padding: 40px; border-radius: 15px;
        border: 1px solid #e2e8f0; box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        max-width: 1100px; margin: auto; color: #1e293b;
    }
    .prompt-box {
        background-color: #0f172a; color: #38bdf8; padding: 25px;
        border-radius: 10px; font-family: 'Consolas', monospace;
        font-size: 0.95em; border: 1px solid #334155;
    }
    </style>
""", unsafe_allow_html=True)

# --- MAPEOS ---
DIAS_ORDENADOS = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo']
DIAS_MAP = {'Monday': 'Lunes', 'Tuesday': 'Martes', 'Wednesday': 'Mi√©rcoles', 'Thursday': 'Jueves', 'Friday': 'Viernes', 'Saturday': 'S√°bado', 'Sunday': 'Domingo'}
MESES_MAP = {'January': 'Enero', 'February': 'Febrero', 'March': 'Marzo', 'April': 'Abril', 'May': 'Mayo', 'June': 'Junio', 'July': 'Julio', 'August': 'Agosto', 'September': 'Septiembre', 'October': 'Octubre', 'November': 'Noviembre', 'December': 'Diciembre'}

# --- PROCESAMIENTO ADAPTADO AL CSV REAL ---
@st.cache_data
def procesar_archivo_v6(uploaded_file):
    try:
        # 1. Lectura con delimitador autom√°tico (detecta el ';' del archivo)
        if uploaded_file.name.endswith('.csv'):
            uploaded_file.seek(0)
            df = pd.read_csv(uploaded_file, sep=None, engine='python', encoding='latin-1')
        else:
            try: df = pd.read_excel(uploaded_file, sheet_name="TABLA HORARIA")
            except: df = pd.read_excel(uploaded_file)

        df.columns = df.columns.astype(str).str.strip()

        # 2. Identificaci√≥n de columnas cr√≠ticas
        col_fecha = next((c for c in df.columns if c.upper() == 'FECHA'), None)
        col_hora = next((c for c in df.columns if c.upper() == 'HORA'), None)
        col_energia = next((c for c in df.columns if 'ENERGIA' in c.upper()), None)
        col_sede = next((c for c in df.columns if c.upper() == 'NOMBRE'), None)
        col_tarifa_base = next((c for c in df.columns if c.upper() == 'TARIFA'), None)

        if col_fecha and col_hora:
            # Limpieza de fechas con el formato detectado (D/MM/YYYY)
            df['fecha_dt'] = pd.to_datetime(df[col_fecha], dayfirst=True, errors='coerce', format='mixed')

            # PARSE DE HORA CR√çTICO: El archivo usa "1:00:00 p. m."
            # Normalizamos el formato de hora para Python
            df['hora_str'] = df[col_hora].astype(str).str.replace('p. m.', 'PM').str.replace('a. m.', 'AM').str.strip()

            # Convertimos a objeto datetime para extraer la hora num√©rica correctamente
            temp_hora = pd.to_datetime(df['hora_str'], format='%I:%M:%S %p', errors='coerce')
            df['hora_num'] = temp_hora.dt.hour

            # Si fall√≥ el parse (por el formato regional), intentamos backup
            if df['hora_num'].isnull().all():
                df['hora_num'] = df[col_hora].astype(str).str.extract('(\d+)').astype(float).fillna(0).astype(int)

            # 3. Limpieza de Energ√≠a (manejo de comas decimales y s√≠mbolos)
            def clean_numeric(x):
                if isinstance(x, str):
                    x = x.replace('$', '').replace('.', '').replace(',', '.').strip()
                return pd.to_numeric(x, errors='coerce')

            df['kwh'] = df[col_energia].apply(clean_numeric).fillna(0)

            # 4. Clasificaci√≥n de Tarifa de Auditor√≠a (L√≥gica de Consultor√≠a)
            def clasificar_auditoria(h):
                if 18 <= h <= 21: return 'Punta'
                elif (8 <= h <= 17) or (h == 22) or (h == 23): return 'Valle'
                else: return 'Super Valle'

            df['tarifa_auditoria'] = df['hora_num'].apply(clasificar_auditoria)

            # Precios de Consultor√≠a
            costos = {'Punta': 0.52, 'Valle': 0.28, 'Super Valle': 0.12}
            df['costo_estimado'] = df['kwh'] * df['tarifa_auditoria'].map(costos)

            # Atributos Temporales
            df['dia_nombre'] = df['fecha_dt'].dt.day_name().map(DIAS_MAP)
            df['mes_nombre'] = df['fecha_dt'].dt.month_name().map(MESES_MAP)
            df['sede_label'] = df[col_sede] if col_sede else "Sede √önica"

            return df.dropna(subset=['fecha_dt'])
        return None
    except Exception as e:
        st.error(f"Error t√©cnico en procesamiento: {e}")
        return None

# --- UI ---
if "auth_state" not in st.session_state: st.session_state.auth_state = False

if not st.session_state.auth_state:
    st.title("üõ°Ô∏è Energy Expert Portal v6.0")
    u, p = st.text_input("Ingeniero"), st.text_input("Clave", type="password")
    if st.button("Acceder"):
        if u == "admin" and p == "admin123":
            st.session_state.auth_state = True
            st.rerun()
else:
    st.sidebar.title("üìä Control de Telemetr√≠a")
    cliente_input = st.sidebar.text_input("Cliente", "MANUFACTURAS ELIOT")
    consultor_input = st.sidebar.text_input("Consultor", "Ing. Auditor")

    archivo = st.sidebar.file_uploader("Subir CSV de Telemetr√≠a", type=["csv", "xlsx"])

    if archivo:
        data = procesar_archivo_v6(archivo)
        if data is not None:
            st.session_state.df_master = data

    if "df_master" in st.session_state:
        df = st.session_state.df_master

        # Filtro de Sede din√°mico basado en columna "Nombre"
        sedes = ["Todas"] + sorted(df['sede_label'].unique().tolist())
        sede_sel = st.sidebar.selectbox("Sede / Punto de Medici√≥n", sedes)
        df_view = df if sede_sel == "Todas" else df[df['sede_label'] == sede_sel]

        tabs = st.tabs(["üìâ Dashboard", "üî• Mapa de Calor", "üîã Carga Base", "üß† IA Consultant", "üìÑ Informe"])

        # KPIs Globales
        perfil_h = df_view.groupby('hora_num')['kwh'].mean().reset_index()
        total_kwh = df_view['kwh'].sum()
        total_costo = df_view['costo_estimado'].sum()
        pico_max = df_view['kwh'].max()
        load_factor = (total_kwh / (pico_max * len(df_view))) if pico_max > 0 else 0

        with tabs[0]:
            st.subheader(f"An√°lisis Operativo: {sede_sel}")
            m1, m2, m3, m4 = st.columns(4)
            m1.metric("Consumo Total", f"{total_kwh:,.0f} kWh")
            m2.metric("Demanda M√°xima", f"{pico_max:,.1f} kW")
            m3.metric("Costo Auditor√≠a", f"${total_costo:,.2f}")
            m4.metric("Factor de Carga", f"{load_factor:.2f}")

            c1, c2 = st.columns(2)
            fig_l = px.line(perfil_h, x='hora_num', y='kwh', title="Curva de Carga Promedio", markers=True)
            c1.plotly_chart(fig_l, use_container_width=True, key="dash_l")

            df_pie = df_view.groupby('tarifa_auditoria')['costo_estimado'].sum().reset_index()
            fig_p = px.pie(df_pie, values='costo_estimado', names='tarifa_auditoria', hole=.4, title="Distribuci√≥n de Costos por Bloque",
                           color_discrete_map={'Punta': '#ef4444', 'Valle': '#f59e0b', 'Super Valle': '#10b981'})
            c2.plotly_chart(fig_p, use_container_width=True, key="dash_p")

        with tabs[1]:
            st.subheader("Mapa de Calor de Consumo")
            heat = df_view.groupby(['dia_nombre', 'hora_num'])['kwh'].mean().reset_index()
            heat_p = heat.pivot(index='hora_num', columns='dia_nombre', values='kwh')
            cols_heat = [d for d in DIAS_ORDENADOS if d in heat_p.columns]
            fig_h = px.imshow(heat_p[cols_heat], color_continuous_scale='YlOrRd', title="Intensidad Horaria")
            st.plotly_chart(fig_h, use_container_width=True, key="heat_m")

        with tabs[2]:
            st.subheader("An√°lisis de Baseload (Carga Base)")
            base_df = df_view.groupby('hora_num')['kwh'].min().reset_index()
            baseload_val = base_df['kwh'].min()
            st.success(f"Carga Base m√≠nima detectada: {baseload_val:,.2f} kW. Representa equipos que nunca se apagan.")

            fig_b = go.Figure()
            fig_b.add_trace(go.Scatter(x=perfil_h['hora_num'], y=perfil_h['kwh'], name="Promedio", fill='tonexty'))
            fig_b.add_trace(go.Scatter(x=base_df['hora_num'], y=base_df['kwh'], name="Baseload", fill='tozeroy'))
            st.plotly_chart(fig_b, use_container_width=True, key="base_l")

        with tabs[3]:
            st.subheader("Diagn√≥stico para Consultor√≠a IA")
            p_punta = (df_view[df_view['tarifa_auditoria'] == 'Punta']['kwh'].sum() / total_kwh) * 100
            prompt = f"""
            Act√∫a como Consultor Energ√©tico Senior. Analiza los datos de {sede_sel}:
            - Consumo: {total_kwh:,.0f} kWh.
            - Factor de Carga: {load_factor:.2f}.
            - Consumo en Horas Punta: {p_punta:.1f}%.
            - Baseload: {baseload_val:,.2f} kW.

            Genera 3 estrategias para reducir el costo operativo bas√°ndote en que la tarifa Punta es la m√°s cara.
            """
            st.markdown(f'<div class="prompt-box">{prompt}</div>', unsafe_allow_html=True)

        with tabs[4]:
            st.subheader("Vista Previa de Informe Profesional")
            st.markdown('<div class="report-container">', unsafe_allow_html=True)
            st.markdown(f"## INFORME DE AUDITOR√çA ENERG√âTICA")
            st.write(f"**Cliente:** {cliente_input} | **Punto de Medici√≥n:** {sede_sel}")
            st.write(f"**Fecha:** {datetime.now().strftime('%d/%m/%Y')} | **Consultor:** {consultor_input}")
            st.divider()
            st.markdown("### Hallazgos Principales")
            st.write(f"1. Se identific√≥ un pico m√°ximo de **{pico_max:,.2f} kW**.")
            st.write(f"2. El factor de carga de **{load_factor:.2f}** sugiere {'una alta eficiencia' if load_factor > 0.7 else 'una oportunidad de mejora en la gesti√≥n de picos'}.")
            st.write(f"3. El consumo base (Baseload) es de **{baseload_val:,.2f} kW**, lo que equivale a un consumo pasivo constante.")

            fig_rep = px.line(perfil_h, x='hora_num', y='kwh', title="Curva de Carga Base del Informe")
            st.plotly_chart(fig_rep, use_container_width=True, key="rep_l")

            st.markdown("<br><br><p style='text-align:center;'>__________________________<br>Firma Autorizada</p>", unsafe_allow_html=True)
            st.markdown('</div>', unsafe_allow_html=True)
    else:
        st.info("üëã Ingeniero, cargue el archivo CSV para realizar el an√°lisis basado en su base de datos.")