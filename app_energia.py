# -*- coding: utf-8 -*-
"""Aplicaci√≥n de Consultor√≠a Energ√©tica Avanzada

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1PfKGyIQhuhCV09U1D949T334Caqap8Oy
"""

import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
import numpy as np
from datetime import datetime

# --- CONFIGURACI√ìN DE P√ÅGINA ---
st.set_page_config(
    page_title="Consultor√≠a Energ√©tica Expert BI",
    page_icon="‚ö°",
    layout="wide",
)

# --- ESTILOS DE INGENIER√çA ---
st.markdown("""
    <style>
    .report-container {
        background-color: white; padding: 40px; border-radius: 15px;
        border: 1px solid #e2e8f0; box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        max-width: 1100px; margin: auto; color: #1e293b;
    }
    .metric-card {
        background-color: #f8fafc; padding: 20px; border-radius: 10px;
        border-top: 4px solid #1e40af; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .prompt-box {
        background-color: #0f172a; color: #38bdf8; padding: 25px;
        border-radius: 10px; font-family: 'Consolas', monospace;
        font-size: 0.95em; border: 1px solid #334155;
    }
    </style>
""", unsafe_allow_html=True)

# --- CONSTANTES DE INGENIER√çA ---
DIAS_ORDENADOS = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo']
MESES_ORDENADOS = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre']
DIAS_MAP = {'Monday': 'Lunes', 'Tuesday': 'Martes', 'Wednesday': 'Mi√©rcoles', 'Thursday': 'Jueves', 'Friday': 'Viernes', 'Saturday': 'S√°bado', 'Sunday': 'Domingo'}
MESES_MAP = {'January': 'Enero', 'February': 'Febrero', 'March': 'Marzo', 'April': 'Abril', 'May': 'Mayo', 'June': 'Junio', 'July': 'Julio', 'August': 'Agosto', 'September': 'Septiembre', 'October': 'Octubre', 'November': 'Noviembre', 'December': 'Diciembre'}

# --- PROCESAMIENTO T√âCNICO ---
@st.cache_data
def procesar_archivo_v3(uploaded_file):
    try:
        if uploaded_file.name.endswith('.csv'):
            for encoding in ['utf-8', 'latin-1', 'iso-8859-1']:
                try:
                    uploaded_file.seek(0)
                    df = pd.read_csv(uploaded_file, sep=None, engine='python', encoding=encoding)
                    break
                except: continue
        else:
            try: df = pd.read_excel(uploaded_file, sheet_name="TABLA HORARIA")
            except: df = pd.read_excel(uploaded_file)

        df.columns = df.columns.astype(str).str.strip()
        df = df.dropna(how='all', axis=0)

        # Identificaci√≥n de columnas
        col_fecha = next((c for c in df.columns if c.lower() in ['fecha', 'date', 'timestamp']), None)

        if col_fecha:
            # Pivotar si vienen horas en columnas (H1...H24)
            cols_horas = [c for c in df.columns if c.upper().startswith('H') and any(char.isdigit() for char in c)]
            if cols_horas:
                df = df.melt(id_vars=[c for c in df.columns if c not in cols_horas],
                             value_vars=cols_horas, var_name='Hora_Label', value_name='kWh_Raw')
                df['hora_num'] = df['Hora_Label'].str.extract('(\d+)').astype(int)
            else:
                df['hora_num'] = pd.to_datetime(df[col_fecha]).dt.hour

            df['fecha_dt'] = pd.to_datetime(df[col_fecha], errors='coerce')
            df['kwh'] = pd.to_numeric(df.get('kWh_Raw', df.get('ENERGIA KWH', df.get('VALOR', 0))), errors='coerce').fillna(0)
            df = df.dropna(subset=['fecha_dt'])

            # Atributos temporales
            df['dia_nombre'] = df['fecha_dt'].dt.day_name().map(DIAS_MAP)
            df['mes_nombre'] = df['fecha_dt'].dt.month_name().map(MESES_MAP)
            df['fecha_solo'] = df['fecha_dt'].dt.date

            # --- SEGMENTACI√ìN CELDA POR CELDA (HORA A HORA) ---
            def asignar_tarifa_precisa(h):
                if 18 <= h <= 21: return 'Punta'
                elif (8 <= h <= 17) or (h == 22) or (h == 23): return 'Valle'
                else: return 'Super Valle'

            df['tarifa'] = df['hora_num'].apply(asignar_tarifa_precisa)

            # Precios de Consultor√≠a (Ajustables)
            costos = {'Punta': 0.52, 'Valle': 0.28, 'Super Valle': 0.12}
            df['costo_estimado'] = df.apply(lambda r: r['kwh'] * costos[r['tarifa']], axis=1)

            return df
        return None
    except Exception as e:
        st.error(f"Error t√©cnico: {e}")
        return None

# --- UI ---
if "auth_state" not in st.session_state: st.session_state.auth_state = False

if not st.session_state.auth_state:
    st.title("üõ°Ô∏è Energy Expert Portal")
    u, p = st.text_input("Ingeniero"), st.text_input("Clave", type="password")
    if st.button("Acceder"):
        if u == "admin" and p == "admin123":
            st.session_state.auth_state = True
            st.rerun()
else:
    # Sidebar de Control
    st.sidebar.title("üìä Control de Auditor√≠a")
    cliente_input = st.sidebar.text_input("Nombre del Cliente/Empresa", "Sider√∫rgica del Norte")
    consultor_nombre = st.sidebar.text_input("Ingeniero Responsable", "Ing. Carlos Mendoza")
    logo_file = st.sidebar.file_uploader("Logo Corporativo", type=["png", "jpg"])

    archivo = st.sidebar.file_uploader("Cargar Telemetr√≠a (CSV/XLSX)", type=["csv", "xlsx"])
    if archivo:
        data = procesar_archivo_v3(archivo)
        if data is not None: st.session_state.df_master = data

    if "df_master" in st.session_state:
        df = st.session_state.df_master

        # Filtro de Sede/Nombre si existe
        col_nombre = next((c for c in df.columns if 'nombre' in c.lower() or 'cliente' in c.lower()), None)
        if col_nombre:
            lista_sedes = ["Todas las Sedes"] + sorted(list(df[col_nombre].unique()))
            sede_sel = st.sidebar.selectbox("Seleccionar Sede", lista_sedes)
            df_view = df if sede_sel == "Todas las Sedes" else df[df[col_nombre] == sede_sel]
        else:
            df_view = df
            sede_sel = cliente_input

        tabs = st.tabs(["üìà Dashboard", "üî• Mapa t√©rmico", "üìâ Carga Base", "üß† Prompt de Auditor√≠a", "üìÑ Informe"])

        with tabs[0]:
            st.subheader(f"An√°lisis Operativo: {sede_sel}")
            # KPIs
            k1, k2, k3, k4 = st.columns(4)
            total_kwh = df_view['kwh'].sum()
            k1.metric("Energ√≠a Total", f"{total_kwh:,.1f} kWh")
            k2.metric("Pico de Demanda", f"{df_view['kwh'].max():,.1f} kW")
            k3.metric("Costo Proyectado", f"${df_view['costo_estimado'].sum():,.2f}")
            # Factor de carga (Ingenier√≠a)
            fc = (total_kwh / (df_view['kwh'].max() * len(df_view))) if total_kwh > 0 else 0
            k4.metric("Factor de Carga", f"{fc:.2f}")

            c1, c2 = st.columns(2)
            # Perfil Horario Promedio
            perfil_h = df_view.groupby('hora_num')['kwh'].mean().reset_index()
            fig_h = px.area(perfil_h, x='hora_num', y='kwh', title="Curva de Carga Promedio (kW)",
                             color_discrete_sequence=['#1e40af'])
            c1.plotly_chart(fig_h, use_container_width=True, key="dash_h")

            # Mix Tarifario
            df_t = df_view.groupby('tarifa')['kwh'].sum().reset_index()
            fig_t = px.pie(df_t, names='tarifa', values='kwh', hole=0.5, title="Distribuci√≥n de Energ√≠a por Bloque",
                           color_discrete_map={'Punta': '#ef4444', 'Valle': '#f59e0b', 'Super Valle': '#10b981'})
            c2.plotly_chart(fig_t, use_container_width=True, key="dash_t")

        with tabs[1]:
            st.subheader("Mapa de Calor: Intensidad de Consumo")
            st.write("Identificaci√≥n visual de anomal√≠as operativas y picos de demanda por d√≠a y hora.")

            # Pivot para Heatmap
            heatmap_data = df_view.groupby(['dia_nombre', 'hora_num'])['kwh'].mean().reset_index()
            heatmap_pivot = heatmap_data.pivot(index='hora_num', columns='dia_nombre', values='kwh')
            heatmap_pivot = heatmap_pivot[DIAS_ORDENADOS] # Reordenar d√≠as

            fig_heat = px.imshow(heatmap_pivot,
                                 labels=dict(x="D√≠a de la Semana", y="Hora del D√≠a", color="Consumo (kWh)"),
                                 color_continuous_scale=[(0, "green"), (0.5, "yellow"), (1, "red")],
                                 aspect="auto")
            st.plotly_chart(fig_heat, use_container_width=True)

            if st.button("üìå Anclar Mapa al Informe"):
                if "pinned" not in st.session_state: st.session_state.pinned = []
                st.session_state.pinned.append({"fig": fig_heat, "title": "Mapa T√©rmico de Carga"})

        with tabs[2]:
            st.subheader("An√°lisis de Carga Base (Baseload)")
            st.write("Detecci√≥n del consumo m√≠nimo persistente. √ötil para identificar equipos que no se apagan o fugas el√©ctricas.")

            # C√°lculo de carga base
            carga_base_df = df_view.groupby('hora_num')['kwh'].min().reset_index()
            min_kwh = carga_base_df['kwh'].min()
            hora_min = carga_base_df.loc[carga_base_df['kwh'].idxmin(), 'hora_num']

            st.info(f"‚ö° **Carga Base Detectada:** {min_kwh:,.2f} kWh | **Horario de m√≠nima:** {hora_min}:00 hrs")

            fig_base = go.Figure()
            fig_base.add_trace(go.Scatter(x=carga_base_df['hora_num'], y=carga_base_df['kwh'],
                                          name="Carga M√≠nima", line=dict(color='green', dash='dot')))
            fig_base.add_trace(go.Scatter(x=perfil_h['hora_num'], y=perfil_h['kwh'],
                                          name="Carga Promedio", line=dict(color='blue')))
            fig_base.update_layout(title="Carga Base vs Carga Promedio", xaxis_title="Hora", yaxis_title="kWh")
            st.plotly_chart(fig_base, use_container_width=True)

        with tabs[3]:
            st.subheader("Generador de Prompt Maestro (Ingenier√≠a El√©ctrica)")
            st.write("Copia este prompt detallado para obtener una consultor√≠a de IA nivel experto.")

            # Extracci√≥n de m√©tricas para el prompt
            df_punta = df_view[df_view['tarifa'] == 'Punta']
            consumo_punta = df_punta['kwh'].sum()
            avg_punta = df_punta['kwh'].mean()

            prompt = f"""
            Act√∫a como un Consultor Senior en Ingenier√≠a El√©ctrica y Gesti√≥n de la Demanda.
            Analiza el perfil energ√©tico del cliente '{sede_sel}'.

            DATOS T√âCNICOS PROCESADOS:
            - Energ√≠a Total: {total_kwh:,.2f} kWh
            - Carga Base (Stand-by): {min_kwh:,.2f} kW (Persistente en madrugadas).
            - Factor de Carga Actual: {fc:.2f} (Indicador de utilizaci√≥n de infraestructura).
            - Consumo en Horario Punta (18h-22h): {consumo_punta:,.2f} kWh ({ (consumo_punta/total_kwh)*100 :.1f}% del total).
            - Pico M√°ximo de Demanda: {df_view['kwh'].max():,.2f} kW.

            REQUERIMIENTO DE AUDITOR√çA:
            1. Analiza si el Factor de Carga de {fc:.2f} justifica una penalizaci√≥n por bajo uso o si el cliente est√° pagando capacidad ociosa.
            2. Eval√∫a el impacto de desplazar el {avg_punta:.1f} kW promedio del horario punta hacia el horario Super Valle.
            3. Diagnostica la Carga Base de {min_kwh:,.2f} kW: ¬øEs razonable para una operaci√≥n industrial o indica ineficiencia en apagado de luminarias/motores?
            4. Prop√≥n 3 tecnolog√≠as espec√≠ficas (BESS, Variadores de Frecuencia, o Gesti√≥n de Activos) fundamentadas en estos n√∫meros.

            DAME UN AN√ÅLISIS CR√çTICO, T√âCNICO Y CON C√ÅLCULOS DE RETORNO (ROI) ESTIMADOS.
            """
            st.markdown(f'<div class="prompt-box">{prompt}</div>', unsafe_allow_html=True)

        with tabs[4]:
            st.subheader("Informe T√©cnico de Gesti√≥n")
            st.markdown('<div class="report-container">', unsafe_allow_html=True)

            c_logo, c_title = st.columns([1, 2])
            with c_logo:
                if logo_file: st.image(logo_file, width=150)
            with c_title:
                st.markdown(f"<h2 style='text-align:right;'>INFORME T√âCNICO: {sede_sel}</h2>", unsafe_allow_html=True)
                st.markdown(f"<p style='text-align:right;'>Fecha: {datetime.now().strftime('%d/%m/%Y')}</p>", unsafe_allow_html=True)

            st.divider()
            st.markdown("### 1. Diagn√≥stico de Consumo")
            st.write(f"Durante el periodo analizado, se registr√≥ un consumo total de **{total_kwh:,.1f} kWh**, con una facturaci√≥n proyectada de **${df_view['costo_estimado'].sum():,.2f}** bajo estructura de tarifas horarias.")

            st.plotly_chart(fig_h, use_container_width=True, key="report_h")

            st.markdown("### 2. Eficiencia de Carga")
            st.write(f"El **Factor de Carga ({fc:.2f})** sugiere una oportunidad de optimizaci√≥n de la capacidad contratada. Se detect√≥ una **Carga Base de {min_kwh:,.2f} kW**.")

            if "pinned" in st.session_state:
                for item in st.session_state.pinned:
                    st.markdown(f"### {item['title']}")
                    st.plotly_chart(item['fig'], use_container_width=True)

            st.markdown(f"<br><br><hr><p><b>Certifica:</b> {consultor_nombre}<br><i>Consultor Energ√©tico Senior</i></p>", unsafe_allow_html=True)
            st.markdown('</div>', unsafe_allow_html=True)

            if st.button("üóëÔ∏è Limpiar Informe"):
                st.session_state.pinned = []
                st.rerun()

    else:
        st.info("Ingeniero, por favor cargue los datos de telemetr√≠a en el panel lateral.")