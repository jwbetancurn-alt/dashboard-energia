# -*- coding: utf-8 -*-
"""Aplicaci√≥n de Consultor√≠a Energ√©tica Avanzada

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1zzUaPy7BoVzXFJOtnRbu_X3V6aRTgc0I
"""

import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
import numpy as np
from datetime import datetime

# --- CONFIGURACI√ìN DE P√ÅGINA ---
st.set_page_config(
    page_title="Consultor√≠a Energ√©tica Expert BI",
    page_icon="‚ö°",
    layout="wide",
)

# --- ESTILOS DE INGENIER√çA ---
st.markdown("""
    <style>
    .report-container {
        background-color: white; padding: 40px; border-radius: 15px;
        border: 1px solid #e2e8f0; box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        max-width: 1100px; margin: auto; color: #1e293b;
    }
    .metric-card {
        background-color: #f8fafc; padding: 20px; border-radius: 10px;
        border-top: 4px solid #1e40af; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .prompt-box {
        background-color: #0f172a; color: #38bdf8; padding: 25px;
        border-radius: 10px; font-family: 'Consolas', monospace;
        font-size: 0.95em; border: 1px solid #334155;
    }
    .stMetric {
        background: #ffffff;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    </style>
""", unsafe_allow_html=True)

# --- CONSTANTES DE INGENIER√çA ---
DIAS_ORDENADOS = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo']
MESES_ORDENADOS = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre']
DIAS_MAP = {'Monday': 'Lunes', 'Tuesday': 'Martes', 'Wednesday': 'Mi√©rcoles', 'Thursday': 'Jueves', 'Friday': 'Viernes', 'Saturday': 'S√°bado', 'Sunday': 'Domingo'}
MESES_MAP = {'January': 'Enero', 'February': 'Febrero', 'March': 'Marzo', 'April': 'Abril', 'May': 'Mayo', 'June': 'Junio', 'July': 'Julio', 'August': 'Agosto', 'September': 'Septiembre', 'October': 'Octubre', 'November': 'Noviembre', 'December': 'Diciembre'}

# --- PROCESAMIENTO T√âCNICO ROBUSTO ---
@st.cache_data
def procesar_archivo_v4(uploaded_file):
    try:
        if uploaded_file.name.endswith('.csv'):
            for encoding in ['utf-8', 'latin-1', 'iso-8859-1']:
                try:
                    uploaded_file.seek(0)
                    df = pd.read_csv(uploaded_file, sep=None, engine='python', encoding=encoding)
                    break
                except: continue
        else:
            try: df = pd.read_excel(uploaded_file, sheet_name="TABLA HORARIA")
            except: df = pd.read_excel(uploaded_file)

        df.columns = df.columns.astype(str).str.strip()
        df = df.dropna(how='all', axis=0)

        # Identificaci√≥n inteligente de columnas
        col_fecha = next((c for c in df.columns if c.lower() in ['fecha', 'date', 'timestamp', 'fec']), None)

        if col_fecha:
            # Soluci√≥n al error de formato de fecha: format='mixed' y dayfirst=True
            df['fecha_dt'] = pd.to_datetime(df[col_fecha], dayfirst=True, errors='coerce', format='mixed')

            # Pivotar si vienen horas en columnas (H1...H24)
            cols_horas = [c for c in df.columns if c.upper().startswith('H') and any(char.isdigit() for char in c)]
            if cols_horas:
                df = df.melt(id_vars=[c for c in df.columns if c not in cols_horas],
                             value_vars=cols_horas, var_name='Hora_Label', value_name='kWh_Raw')
                df['hora_num'] = df['Hora_Label'].str.extract('(\d+)').astype(int)
                # Si es formato H1-H24, a veces H24 es las 00h del d√≠a siguiente. Ajustamos:
                df.loc[df['hora_num'] == 24, 'hora_num'] = 0
            else:
                df['hora_num'] = df['fecha_dt'].dt.hour

            # Limpieza de energ√≠a
            terminos_energia = ['kwh', 'energia', 'valor', 'active', 'potencia', 'consumo']
            col_kwh = next((c for c in df.columns if any(t in c.lower() for t in terminos_energia)), None)

            df['kwh'] = pd.to_numeric(df[col_kwh], errors='coerce').fillna(0)
            df = df.dropna(subset=['fecha_dt'])

            # Atributos temporales
            df['dia_nombre'] = df['fecha_dt'].dt.day_name().map(DIAS_MAP)
            df['mes_nombre'] = df['fecha_dt'].dt.month_name().map(MESES_MAP)
            df['fecha_solo'] = df['fecha_dt'].dt.date

            # --- SEGMENTACI√ìN HORA A HORA SIN PROMEDIOS ---
            def asignar_tarifa_precisa(h):
                if 18 <= h <= 21: return 'Punta'
                elif (8 <= h <= 17) or (h == 22) or (h == 23): return 'Valle'
                else: return 'Super Valle'

            df['tarifa'] = df['hora_num'].apply(asignar_tarifa_precisa)

            # Tarifario de Consultor√≠a
            costos = {'Punta': 0.52, 'Valle': 0.28, 'Super Valle': 0.12}
            df['costo_estimado'] = df['kwh'] * df['tarifa'].map(costos)

            return df
        return None
    except Exception as e:
        st.error(f"Error t√©cnico detectado: {e}")
        return None

# --- UI PRINCIPAL ---
if "auth_state" not in st.session_state: st.session_state.auth_state = False

if not st.session_state.auth_state:
    st.title("üõ°Ô∏è Energy Expert Portal v4.0")
    u, p = st.text_input("Ingeniero"), st.text_input("Clave", type="password")
    if st.button("Acceder al Sistema"):
        if u == "admin" and p == "admin123":
            st.session_state.auth_state = True
            st.rerun()
else:
    # Sidebar
    st.sidebar.title("üìä Control de Auditor√≠a")
    cliente_nombre = st.sidebar.text_input("Empresa Cliente", "Sider√∫rgica del Norte S.A.")
    consultor_id = st.sidebar.text_input("Consultor Responsable", "Ing. Carlos Mendoza")
    logo_img = st.sidebar.file_uploader("Cargar Logo", type=["png", "jpg"])

    archivo = st.sidebar.file_uploader("Telemetr√≠a (Excel/CSV)", type=["csv", "xlsx"])
    if archivo:
        data = procesar_archivo_v4(archivo)
        if data is not None: st.session_state.df_master = data

    if "df_master" in st.session_state:
        df = st.session_state.df_master

        # Filtro de Sede
        col_sede = next((c for c in df.columns if 'nombre' in c.lower() or 'cliente' in c.lower() or 'sede' in c.lower()), None)
        if col_sede:
            opciones = ["Todas las Sedes"] + sorted(list(df[col_sede].unique()))
            sede_sel = st.sidebar.selectbox("Seleccionar Sede", opciones)
            df_view = df if sede_sel == "Todas las Sedes" else df[df[col_sede] == sede_sel]
        else:
            df_view = df
            sede_sel = cliente_nombre

        tabs = st.tabs(["üìâ Dashboard", "üî• Mapa de Calor", "üîã An√°lisis Baseload", "üìä Volatilidad", "üß† Prompt IA", "üìÑ Informe"])

        with tabs[0]:
            st.subheader(f"Dashboard Operativo - {sede_sel}")
            total_kwh = df_view['kwh'].sum()
            total_costo = df_view['costo_estimado'].sum()
            pico_max = df_view['kwh'].max()
            # Factor de Carga Real
            horas_periodo = len(df_view)
            load_factor = (total_kwh / (pico_max * horas_periodo)) if pico_max > 0 else 0

            k1, k2, k3, k4 = st.columns(4)
            k1.metric("Energ√≠a Total", f"{total_kwh:,.1f} kWh")
            k2.metric("Pico Demanda", f"{pico_max:,.1f} kW")
            k3.metric("Costo Estimado", f"${total_costo:,.2f}")
            k4.metric("Factor de Carga", f"{load_factor:.2f}", help="Cercano a 1 es √≥ptimo. Bajo 0.4 indica picos ineficientes.")

            c1, c2 = st.columns(2)
            perfil_h = df_view.groupby('hora_num')['kwh'].mean().reset_index()
            fig_h = px.line(perfil_h, x='hora_num', y='kwh', title="Curva de Carga Promedio (kW)", markers=True)
            c1.plotly_chart(fig_h, use_container_width=True)

            df_t = df_view.groupby('tarifa')['costo_estimado'].sum().reset_index()
            fig_t = px.pie(df_t, names='tarifa', values='costo_estimado', hole=0.5, title="Intensidad de Facturaci√≥n ($)",
                           color_discrete_map={'Punta': '#ef4444', 'Valle': '#f59e0b', 'Super Valle': '#10b981'})
            c2.plotly_chart(fig_t, use_container_width=True)

        with tabs[1]:
            st.subheader("An√°lisis T√©rmico de Intensidad")
            heatmap_data = df_view.groupby(['dia_nombre', 'hora_num'])['kwh'].mean().reset_index()
            heatmap_pivot = heatmap_data.pivot(index='hora_num', columns='dia_nombre', values='kwh')
            heatmap_pivot = heatmap_pivot[[d for d in DIAS_ORDENADOS if d in heatmap_pivot.columns]]

            fig_heat = px.imshow(heatmap_pivot, color_continuous_scale='RdYlGn_r', aspect="auto",
                                 title="Mapa T√©rmico: ¬øCu√°ndo ocurre el mayor consumo?")
            st.plotly_chart(fig_heat, use_container_width=True)

        with tabs[2]:
            st.subheader("Identificaci√≥n de Carga Base (Baseload)")
            base_df = df_view.groupby('hora_num')['kwh'].min().reset_index()
            baseload_val = base_df['kwh'].min()
            st.info(f"‚ö° Carga Base Detectada: **{baseload_val:,.2f} kW**. Este es el consumo m√≠nimo que nunca se apaga.")

            fig_base = go.Figure()
            fig_base.add_trace(go.Scatter(x=perfil_h['hora_num'], y=perfil_h['kwh'], name="Promedio", line=dict(color='blue')))
            fig_base.add_trace(go.Scatter(x=base_df['hora_num'], y=base_df['kwh'], name="M√≠nimo (Base)", fill='tozeroy', line=dict(color='green')))
            st.plotly_chart(fig_base, use_container_width=True)

        with tabs[3]:
            st.subheader("An√°lisis de Volatilidad y Estabilidad")
            # Desviaci√≥n est√°ndar horaria para ver qu√© horas son m√°s err√°ticas
            volatilidad = df_view.groupby('hora_num')['kwh'].std().reset_index()
            fig_vol = px.bar(volatilidad, x='hora_num', y='kwh', title="Desviaci√≥n Est√°ndar por Hora (Inestabilidad)",
                             color_discrete_sequence=['#6366f1'])
            st.write("Horas con barras altas indican procesos con arranques bruscos o demanda inestable.")
            st.plotly_chart(fig_vol, use_container_width=True)

        with tabs[4]:
            st.subheader("Consultor√≠a de IA (Prompt Maestro)")
            # Datos t√©cnicos para el prompt
            punta_data = df_view[df_view['tarifa'] == 'Punta']
            p_punta = (punta_data['kwh'].sum() / total_kwh) * 100

            prompt = f"""
            Como Ingeniero Electricista Consultor Senior, analiza estos datos del cliente {sede_sel}:
            1. Energ√≠a Total: {total_kwh:,.1f} kWh.
            2. Carga Base: {baseload_val:,.2f} kW.
            3. Consumo en Horas Punta: {p_punta:.1f}% del total.
            4. Factor de Carga: {load_factor:.2f}.

            Diagnostica:
            A) ¬øEs el Baseload excesivo (indica equipos encendidos innecesariamente)?
            B) ¬øEl Factor de Carga justifica instalar bater√≠as para Peak Shaving?
            C) ¬øQu√© impacto tendr√≠a reducir un 10% el consumo en Punta?
            """
            st.markdown(f'<div class="prompt-box">{prompt}</div>', unsafe_allow_html=True)

        with tabs[5]:
            st.subheader("Informe T√©cnico Final")
            st.markdown('<div class="report-container">', unsafe_allow_html=True)
            c_l, c_r = st.columns([1, 2])
            with c_l:
                if logo_img: st.image(logo_img, width=150)
            with c_r:
                st.markdown(f"<h2 style='text-align:right;'>AUDITOR√çA ENERG√âTICA: {sede_sel}</h2>", unsafe_allow_html=True)
                st.markdown(f"<p style='text-align:right;'>Generado por: {consultor_id} | {datetime.now().strftime('%d/%m/%Y')}</p>", unsafe_allow_html=True)

            st.divider()
            st.markdown(f"### 1. Resumen Ejecutivo")
            st.write(f"El an√°lisis de telemetr√≠a revela un consumo de **{total_kwh:,.1f} kWh** con un costo de **${total_costo:,.2f}**. El factor de carga de **{load_factor:.2f}** indica una oportunidad de optimizaci√≥n de potencia.")

            st.plotly_chart(fig_h, use_container_width=True)

            st.markdown("### 2. Hallazgos T√©cnicos")
            st.write(f"- **Carga Par√°sita:** Se detect√≥ una carga base de {baseload_val:,.2f} kW en horas no operativas.")
            st.write(f"- **Impacto Punta:** El bloque de Punta (18h-22h) representa el {p_punta:.1f}% de la energ√≠a consumida.")

            st.markdown(f"<br><br><br><p>__________________________<br><b>Firma del Ingeniero</b><br>{consultor_id}</p>", unsafe_allow_html=True)
            st.markdown('</div>', unsafe_allow_html=True)

    else:
        st.info("Ingeniero, cargue el archivo de telemetr√≠a para iniciar el diagn√≥stico.")