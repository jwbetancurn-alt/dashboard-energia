# -*- coding: utf-8 -*-
"""Aplicaci√≥n de An√°lisis Energ√©tico Pro

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1N_Az6izfm01jN59kKufbHXxxkzoEuWwI
"""

import streamlit as st
import pandas as pd
import plotly.express as px
import requests
import json
import base64
from io import BytesIO
from datetime import datetime

# --- CONFIGURACI√ìN DE P√ÅGINA ---
st.set_page_config(
    page_title="IA Energy Consultant Pro",
    page_icon="‚ö°",
    layout="wide",
)

# --- ESTILOS PERSONALIZADOS ---
st.markdown("""
    <style>
    .report-container {
        background-color: white;
        padding: 40px;
        border-radius: 15px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        max-width: 900px;
        margin: auto;
    }
    .stMetric {
        background-color: #ffffff;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .consultant-info {
        margin-top: 30px;
        border-top: 1px solid #eee;
        padding-top: 20px;
    }
    </style>
""", unsafe_allow_html=True)

# --- MAPEOS DE IDIOMA ---
DIAS_MAP = {
    'Monday': 'Lunes', 'Tuesday': 'Martes', 'Wednesday': 'Mi√©rcoles',
    'Thursday': 'Jueves', 'Friday': 'Viernes', 'Saturday': 'S√°bado', 'Sunday': 'Domingo'
}
MESES_MAP = {
    'January': 'Enero', 'February': 'Febrero', 'March': 'Marzo', 'April': 'Abril',
    'May': 'Mayo', 'June': 'Junio', 'July': 'Julio', 'August': 'Agosto',
    'September': 'Septiembre', 'October': 'Octubre', 'November': 'Noviembre', 'December': 'Diciembre'
}

# --- CONSTANTES Y API ---
API_KEY = ""

def llamar_ia_gemini(prompt):
    url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key={API_KEY}"
    payload = {"contents": [{"parts": [{"text": prompt}]}]}
    try:
        response = requests.post(url, json=payload, timeout=15)
        response.raise_for_status()
        result = response.json()
        return result['candidates'][0]['content']['parts'][0]['text']
    except Exception:
        return "‚ö†Ô∏è Nota: El an√°lisis de IA no pudo generarse autom√°ticamente."

# --- PROCESAMIENTO DE DATOS ---
@st.cache_data
def procesar_archivo(uploaded_file):
    try:
        if uploaded_file.name.endswith('.csv'):
            for encoding in ['utf-8', 'latin-1', 'iso-8859-1', 'cp1252']:
                try:
                    uploaded_file.seek(0)
                    df = pd.read_csv(uploaded_file, sep=None, engine='python', encoding=encoding)
                    break
                except UnicodeDecodeError:
                    continue
        else:
            try:
                df = pd.read_excel(uploaded_file, sheet_name="TABLA HORARIA")
            except:
                df = pd.read_excel(uploaded_file)

        # 1. Limpieza inicial de nombres
        df.columns = df.columns.str.strip()
        df = df.dropna(how='all', axis=0)

        # 2. Identificar columnas (Insensible a may√∫sculas)
        cols_originales = list(df.columns)
        col_fecha_orig = next((c for c in cols_originales if c.lower() == 'fecha'), None)

        if col_fecha_orig:
            # Identificar columnas de horas (H1, H2... o h1, h2...)
            value_vars = [c for c in cols_originales if c.upper().startswith('H') and any(char.isdigit() for char in c)]
            id_vars = [c for c in cols_originales if c not in value_vars]

            if value_vars:
                df = df.melt(id_vars=id_vars, value_vars=value_vars, var_name='Hora_Raw', value_name='Energia')

            # Forzar min√∫sculas para consistencia interna
            df.columns = [c.lower() for c in df.columns]

            # Buscar columnas clave tras el melt/renombre
            col_kwh = 'energia' if 'energia' in df.columns else ('kwh' if 'kwh' in df.columns else None)

            if col_kwh:
                df = df.rename(columns={col_kwh: 'kwh'})
                df['fecha_dt'] = pd.to_datetime(df['fecha'], errors='coerce')
                df['kwh'] = pd.to_numeric(df['kwh'], errors='coerce')
                df = df.dropna(subset=['fecha_dt', 'kwh'])

                # Extraer n√∫mero de hora
                if 'hora_raw' in df.columns:
                    extracted_hour = df['hora_raw'].astype(str).str.extract('(\d+)')
                    df['hora_num'] = pd.to_numeric(extracted_hour[0], errors='coerce').fillna(0).astype(int)
                else:
                    df['hora_num'] = df['fecha_dt'].dt.hour

                df['dia_nombre'] = df['fecha_dt'].dt.day_name().map(DIAS_MAP)
                df['mes_nombre'] = df['fecha_dt'].dt.month_name().map(MESES_MAP)

                def categorizar_tarifa(h):
                    if 13 <= h <= 18: return 'Alta (Punta)'
                    elif (7 <= h <= 12) or (19 <= h <= 22): return 'Media (Valle)'
                    return 'Baja (Super Valle)'

                df['tarifa'] = df['hora_num'].apply(categorizar_tarifa)
                df['costo_total'] = df['kwh'] * 0.20

                return df
            else:
                st.error("No se encontr√≥ una columna de consumo (Energ√≠a/kWh).")
        else:
            st.error("No se encontr√≥ la columna 'FECHA'. Revise el archivo.")
        return None
    except Exception as e:
        st.error(f"Error t√©cnico: {e}")
        return None

# --- M√ìDULO DE AUTENTICACI√ìN ---
def gestionar_login():
    if "auth_state" not in st.session_state:
        st.session_state.auth_state = False
    if not st.session_state.auth_state:
        st.title("üîê Acceso Plataforma Energy BI")
        u = st.text_input("Usuario")
        p = st.text_input("Contrase√±a", type="password")
        if st.button("Ingresar"):
            usuarios = {"admin": "admin123", "cliente": "cliente2025"}
            if u in usuarios and usuarios[u] == p:
                st.session_state.auth_state = True
                st.session_state.user_role = "Administrador" if u == "admin" else "Cliente"
                st.session_state.user_name = u
                st.rerun()
            else:
                st.error("Credenciales incorrectas")
        return False
    return True

# --- INTERFAZ ---
if gestionar_login():
    st.sidebar.title(f"Hola, {st.session_state.user_name}")
    if st.sidebar.button("Cerrar Sesi√≥n"):
        st.session_state.auth_state = False
        st.rerun()

    st.sidebar.divider()
    logo_file = st.sidebar.file_uploader("Subir Logo", type=["png", "jpg", "jpeg"])
    nombre_cliente = st.sidebar.text_input("Empresa Cliente", "Nombre del Cliente")
    nombre_consultor = st.sidebar.text_input("Consultor", "Juan P√©rez")
    cargo_consultor = st.sidebar.text_input("Cargo", "Especialista Energ√©tico")
    mes_informe_sel = st.sidebar.selectbox("Mes", list(MESES_MAP.values()), index=datetime.now().month - 1)
    fecha_emision = st.sidebar.date_input("Fecha", datetime.now())

    if st.session_state.user_role == "Administrador":
        uploaded_file = st.sidebar.file_uploader("Archivo (CSV/XLSX)", type=["csv", "xlsx"])
        if uploaded_file:
            data = procesar_archivo(uploaded_file)
            if data is not None:
                st.session_state.df_master = data
                st.sidebar.success("‚úÖ Datos listos")

    if "df_master" in st.session_state:
        df = st.session_state.df_master

        # Filtro de cliente interno
        col_filtro = 'nombre' if 'nombre' in df.columns else None
        nombres = ["Todos"] + sorted(list(df[col_filtro].unique())) if col_filtro else ["Todos"]
        cliente_sel_data = st.sidebar.selectbox("Filtrar por (Columna Nombre)", nombres)
        df_view = df if cliente_sel_data == "Todos" else df[df[col_filtro] == cliente_sel_data]

        t1, t2, t3, t4 = st.tabs(["üìä An√°lisis", "üß™ Laboratorio", "üí° IA", "üìÑ Informe Final"])

        with t1:
            st.subheader(f"Dashboard: {nombre_cliente}")
            # Verificaci√≥n de seguridad para evitar KeyError en el renderizado
            if 'hora_num' in df_view.columns and 'kwh' in df_view.columns:
                c1, c2 = st.columns(2)
                df_h = df_view.groupby('hora_num')['kwh'].mean().reset_index()
                c1.plotly_chart(px.line(df_h, x='hora_num', y='kwh', title="Curva de Carga Promedio"), use_container_width=True)

                df_d = df_view.groupby('dia_nombre')['kwh'].sum().reset_index()
                c2.plotly_chart(px.bar(df_d, x='dia_nombre', y='kwh',
                                       category_orders={"dia_nombre": list(DIAS_MAP.values())},
                                       title="Consumo por D√≠a"), use_container_width=True)
            else:
                st.warning("Los datos no tienen el formato esperado para generar gr√°ficas.")

        with t2:
            st.subheader("Gr√°ficas Personalizadas")
            opciones_ejes = [c for c in df_view.columns if c in ["hora_num", "dia_nombre", "tarifa", "mes_nombre"]]
            ca, cb = st.columns(2)
            gx = ca.selectbox("Eje X", opciones_ejes)
            gy = cb.selectbox("Eje Y", ["kwh", "costo_total"])
            st.plotly_chart(px.bar(df_view.groupby(gx)[gy].sum().reset_index(), x=gx, y=gy), use_container_width=True)

        with t3:
            st.subheader("An√°lisis IA")
            p_mover = st.slider("% Energ√≠a a desplazar", 0, 100, 20)
            e_punta = df_view[df_view['tarifa'] == 'Alta (Punta)']['kwh'].sum() if 'tarifa' in df_view.columns else 0
            ahorro_est = e_punta * (p_mover/100) * 0.15
            st.metric("Ahorro Proyectado", f"${ahorro_est:,.2f}")
            if st.button("ü§ñ Generar con Gemini"):
                with st.spinner("Analizando..."):
                    contexto = f"Cliente {nombre_cliente}, Mes {mes_informe_sel}. Consumo: {df_view['kwh'].sum():,.2f} kWh."
                    st.session_state.ia_result = llamar_ia_gemini(f"Analiza profesionalmente: {contexto}")
                    st.write(st.session_state.ia_result)

        with t4:
            st.subheader("Informe Final")
            with st.container():
                st.markdown('<div class="report-container">', unsafe_allow_html=True)
                c_logo, c_head = st.columns([1, 2])
                with c_logo:
                    if logo_file: st.image(logo_file, width=150)
                    else: st.write("LOGO")
                with c_head:
                    st.markdown(f"<h1 style='text-align:right; color:#1e40af;'>INFORME ENERG√âTICO</h1>", unsafe_allow_html=True)
                    st.markdown(f"<p style='text-align:right;'><b>{mes_informe_sel} {fecha_emision.year}</b></p>", unsafe_allow_html=True)

                st.divider()
                st.write(f"**Cliente:** {nombre_cliente}")
                st.write(f"**Fecha de Emisi√≥n:** {fecha_emision.strftime('%d/%m/%Y')}")

                m1, m2 = st.columns(2)
                m1.metric("Consumo Periodo", f"{df_view['kwh'].sum():,.2f} kWh")
                m2.metric("Potencial Ahorro", f"${ahorro_est:,.2f}")

                st.markdown("---")
                st.markdown("#### Conclusiones Estrat√©gicas")
                st.info(st.session_state.get("ia_result", "Pendiente de an√°lisis IA."))

                st.markdown(f"<br><br><p>__________________________<br><b>{nombre_consultor}</b><br>{cargo_consultor}</p>", unsafe_allow_html=True)
                st.markdown('</div>', unsafe_allow_html=True)
            st.caption("Presione Ctrl+P para guardar como PDF.")
    else:
        st.info("Cargue un archivo para comenzar.")