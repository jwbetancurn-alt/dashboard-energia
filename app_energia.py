# -*- coding: utf-8 -*-
"""Dashboard con Perfiles y Seguridad

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1bB1NHzuQtjPhkaw2D4koMUGbS_lEM_9U
"""

import streamlit as st
import pandas as pd
import plotly.express as px
import base64

# --- CONFIGURACI√ìN DE P√ÅGINA ---
st.set_page_config(
    page_title="Monitor Energ√©tico Seguro",
    page_icon="üîê",
    layout="wide",
)

# --- SISTEMA DE AUTENTICACI√ìN SIMPLE ---
def check_password():
    """Devuelve True si el usuario introdujo las credenciales correctas."""
    if "authenticated" not in st.session_state:
        st.session_state["authenticated"] = False

    if not st.session_state["authenticated"]:
        st.title("üîë Acceso al Consultor Energ√©tico")
        user = st.text_input("Usuario")
        password = st.text_input("Contrase√±a", type="password")

        col1, col2 = st.columns(2)
        if col1.button("Iniciar Sesi√≥n"):
            # Base de datos de usuarios simple (En producci√≥n usar algo m√°s robusto)
            users = {
                "admin": {"pass": "admin123", "role": "Administrador"},
                "cliente": {"pass": "cliente2024", "role": "Visualizador"}
            }

            if user in users and users[user]["pass"] == password:
                st.session_state["authenticated"] = True
                st.session_state["user_role"] = users[user]["role"]
                st.session_state["user_name"] = user
                st.rerun()
            else:
                st.error("Usuario o contrase√±a incorrectos")
        return False
    return True

# --- CARGA DE DATOS ---
@st.cache_data
def load_data(file):
    try:
        df = pd.read_csv(file, sep=None, engine='python', encoding='utf-8')
    except:
        file.seek(0)
        df = pd.read_csv(file, sep=None, engine='python', encoding='latin1')

    df.columns = df.columns.str.strip()
    col_map = {col.upper(): col for col in df.columns}

    keys = {
        'FECHA': col_map.get('FECHA') or col_map.get('FECHAS'),
        'ENERGIA': col_map.get('ENERGIA KWH') or col_map.get('ENERGIA') or 'ENERGIA kWH',
        'TARIFA': col_map.get('TARIFA'),
        'NOMBRE': col_map.get('NOMBRE') or col_map.get('EMPRESA'),
    }

    df['FECHA_DT'] = pd.to_datetime(df[keys['FECHA']], errors='coerce')
    df['ENERGIA_NUM'] = pd.to_numeric(df[keys['ENERGIA']], errors='coerce')
    df['Dia_Semana'] = df['FECHA_DT'].dt.day_name()

    df = df.rename(columns={
        keys.get('NOMBRE', 'Nombre'): 'Empresa',
        keys.get('TARIFA', 'Tarifa'): 'Tarifa'
    })
    return df.dropna(subset=['FECHA_DT', 'ENERGIA_NUM'])

# --- L√ìGICA DE LA APLICACI√ìN ---
if check_password():
    # Bot√≥n de cerrar sesi√≥n
    st.sidebar.write(f"üë§ Usuario: **{st.session_state['user_name']}**")
    st.sidebar.write(f"üéñÔ∏è Rol: **{st.session_state['user_role']}**")
    if st.sidebar.button("Cerrar Sesi√≥n"):
        st.session_state["authenticated"] = False
        st.rerun()

    st.title(f"‚ö° Dashboard Energ√©tico - {st.session_state['user_role']}")

    uploaded_file = st.sidebar.file_uploader("Subir CSV de Consumo", type=["csv"])

    if uploaded_file:
        df = load_data(uploaded_file)

        # FILTRO DE PERFIL: Un visualizador quiz√°s solo ve su propia empresa
        empresas = list(df['Empresa'].unique())
        empresa_sel = st.sidebar.selectbox("Sede", empresas)
        df_filtered = df[df['Empresa'] == empresa_sel]

        # Pesta√±as condicionales seg√∫n el ROL
        if st.session_state["user_role"] == "Administrador":
            tabs = st.tabs(["üìä Gr√°ficas", "üìâ Simulador de Ahorro", "üìã Gesti√≥n"])
        else:
            tabs = st.tabs(["üìä Gr√°ficas"]) # El cliente no ve el simulador ni gesti√≥n

        with tabs[0]:
            st.subheader(f"Consumo en {empresa_sel}")
            fig = px.bar(df_filtered.groupby('Dia_Semana')['ENERGIA_NUM'].sum().reset_index(),
                         x='Dia_Semana', y='ENERGIA_NUM', color='ENERGIA_NUM')
            st.plotly_chart(fig, use_container_width=True)

        if st.session_state["user_role"] == "Administrador":
            with tabs[1]:
                st.subheader("Simulador de Estrategia Tarifaria")
                pct = st.slider("Desplazar carga %", 0, 100, 10)
                st.info(f"Simulando ahorro para el {pct}% de la carga...")

            with tabs[2]:
                st.subheader("Configuraci√≥n del Sistema")
                st.write("Aqu√≠ podr√≠as a√±adir nuevos usuarios o cambiar precios base.")

    else:
        st.info("Sube un archivo para comenzar.")