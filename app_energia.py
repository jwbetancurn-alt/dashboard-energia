# -*- coding: utf-8 -*-
"""Dashboard Energ√©tico Inteligente

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1FVwDJTe38rQUFDZ0rsBjH5-qdRM8Zgou
"""

import streamlit as st
import pandas as pd
import plotly.express as px
import requests
import json
import base64
from io import BytesIO

# --- CONFIGURACI√ìN DE P√ÅGINA ---
st.set_page_config(
    page_title="IA Energy Consultant Pro",
    page_icon="‚ö°",
    layout="wide",
)

# --- ESTILOS PERSONALIZADOS ---
st.markdown("""
    <style>
    .report-container {
        background-color: white;
        padding: 30px;
        border-radius: 15px;
        border-left: 8px solid #1e40af;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .stMetric {
        background-color: #ffffff;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    </style>
""", unsafe_allow_html=True)

# --- CONSTANTES ---
API_KEY = "" # El entorno inyectar√° la clave autom√°ticamente

# --- FUNCIONES DE APOYO ---

def call_gemini_ai(prompt):
    """Llamada a la API de Gemini para an√°lisis de datos."""
    url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key={API_KEY}"
    payload = {
        "contents": [{"parts": [{"text": prompt}]}]
    }
    try:
        response = requests.post(url, json=payload, timeout=15)
        result = response.json()
        return result['candidates'][0]['content']['parts'][0]['text']
    except Exception as e:
        return "El an√°lisis de IA no pudo ser generado. Por favor, verifique la conexi√≥n."

@st.cache_data
def load_and_clean_data(file):
    """Carga y limpia el archivo CSV bas√°ndose en los campos detectados."""
    try:
        df = pd.read_csv(file, sep=None, engine='python', encoding='utf-8')
    except:
        file.seek(0)
        df = pd.read_csv(file, sep=None, engine='python', encoding='latin1')

    df.columns = df.columns.str.strip()

    # Mapeo de columnas comunes
    col_map = {
        'ENERGIA': next((c for c in df.columns if 'ENERGIA' in c.upper()), 'Energ√≠a'),
        'FECHA': next((c for c in df.columns if 'FECHA' in c.upper()), 'Fecha'),
        'HORA': next((c for c in df.columns if 'HORA' in c.upper()), 'Hora'),
        'TARIFA': next((c for c in df.columns if 'TARIFA' in c.upper()), 'Tarifa'),
        'COSTO': next((c for c in df.columns if 'VALOR' in c.upper() or 'COSTO' in c.upper()), 'Costo'),
        'NOMBRE': next((c for c in df.columns if 'NOMBRE' in c.upper() or 'SEDE' in c.upper()), 'Sede')
    }

    # Conversiones t√©cnicas
    df['FECHA_DT'] = pd.to_datetime(df[col_map['FECHA']], errors='coerce')
    df['kWh'] = pd.to_numeric(df[col_map['ENERGIA']], errors='coerce')
    df['Costo_Val'] = pd.to_numeric(df[col_map['COSTO']], errors='coerce')
    df['Mes'] = df['FECHA_DT'].dt.month_name()
    df['Dia_Semana'] = df['FECHA_DT'].dt.day_name()
    df['Semana'] = df['FECHA_DT'].dt.isocalendar().week
    df['Hora_Fmt'] = df[col_map['HORA']].astype(str)

    return df.dropna(subset=['kWh', 'FECHA_DT']), col_map

# --- SISTEMA DE AUTENTICACI√ìN ---
def check_auth():
    if "authenticated" not in st.session_state:
        st.session_state.authenticated = False

    if not st.session_state.authenticated:
        st.title("üîê Acceso Plataforma Energ√©tica")
        user = st.text_input("Usuario")
        password = st.text_input("Contrase√±a", type="password")
        if st.button("Iniciar Sesi√≥n"):
            # Credenciales por defecto
            credenciales = {"admin": "admin123", "cliente": "cliente2025"}
            if user in credenciales and credenciales[user] == password:
                st.session_state.authenticated = True
                st.session_state.role = "Administrador" if user == "admin" else "Cliente"
                st.session_state.username = user
                st.rerun()
            else:
                st.error("Credenciales inv√°lidas")
        return False
    return True

# --- L√ìGICA PRINCIPAL ---
if check_auth():
    st.sidebar.title(f"Perfil: {st.session_state.role}")
    if st.sidebar.button("Salir"):
        st.session_state.authenticated = False
        st.rerun()

    # Carga de archivos (Solo para Admin)
    uploaded_file = None
    if st.session_state.role == "Administrador":
        uploaded_file = st.sidebar.file_uploader("Cargar Datos Maestros (CSV)", type=["csv"])
        if uploaded_file:
            st.session_state.master_data = load_and_clean_data(uploaded_file)

    # Verificar si hay datos cargados en la sesi√≥n
    if "master_data" in st.session_state:
        df, mapping = st.session_state.master_data

        # Filtros de Sede
        sedes = ["Todas"] + list(df[mapping['NOMBRE']].unique())
        sede_sel = st.sidebar.selectbox("Seleccionar Empresa/Sede", sedes)
        df_filtered = df if sede_sel == "Todas" else df[df[mapping['NOMBRE']] == sede_sel]

        # PESTA√ëAS
        tabs = ["üìä An√°lisis Temporal", "üß™ Laboratorio de Gr√°ficas", "üí° Simulador de Ahorro", "üìÑ Informe Ejecutivo"]
        t1, t2, t3, t4 = st.tabs(tabs)

        with t1:
            st.subheader("Patrones de Consumo Multinivel")
            c1, c2 = st.columns(2)

            # Comparativo Horario
            h_data = df_filtered.groupby('Hora_Fmt')['kWh'].mean().reset_index()
            c1.plotly_chart(px.line(h_data, x='Hora_Fmt', y='kWh', title="Curva de Carga Promedio (Horas)"), use_container_width=True)

            # Consumo Semanal/Mensual
            m_data = df_filtered.groupby('Mes')['kWh'].sum().reset_index()
            c2.plotly_chart(px.bar(m_data, x='Mes', y='kWh', color='Mes', title="Consumo Total por Mes"), use_container_width=True)

            # Consumo por Tarifa
            t_data = df_filtered.groupby(mapping['TARIFA'])['kWh'].sum().reset_index()
            st.plotly_chart(px.pie(t_data, values='kWh', names=mapping['TARIFA'], title="Distribuci√≥n por Tipo de Tarifa"), use_container_width=True)

        with t2:
            st.subheader("Laboratorio de Gr√°ficas Personalizadas")
            st.info("Administrador: Configure aqu√≠ nuevas visualizaciones seleccionando los campos.")

            col_x, col_y, col_color, col_type = st.columns(4)
            with col_x: x_axis = st.selectbox("Eje X", ["Hora_Fmt", "Dia_Semana", "Mes", mapping['TARIFA'], "Semana"])
            with col_y: y_axis = st.selectbox("Eje Y (M√©trica)", ["kWh", "Costo_Val"])
            with col_color: color_param = st.selectbox("Segmentar por (Color)", [mapping['TARIFA'], mapping['NOMBRE'], "Dia_Semana"])
            with col_type: chart_type = st.radio("Tipo de Gr√°fico", ["Barras", "L√≠neas", "√Årea"])

            df_custom = df_filtered.groupby([x_axis, color_param])[y_axis].sum().reset_index()

            if chart_type == "Barras":
                fig_custom = px.bar(df_custom, x=x_axis, y=y_axis, color=color_param, barmode="group")
            elif chart_type == "L√≠neas":
                fig_custom = px.line(df_custom, x=x_axis, y=y_axis, color=color_param)
            else:
                fig_custom = px.area(df_custom, x=x_axis, y=y_axis, color=color_param)

            st.plotly_chart(fig_custom, use_container_width=True)

        with t3:
            st.subheader("Simulador de Estrategia de Ahorro")
            st.write("Mueva porcentajes de carga desde la tarifa m√°s alta a otras franjas.")

            cs1, cs2 = st.columns(2)
            with cs1:
                p_media = st.slider("% Mover de PUNTA a MEDIA", 0, 100, 15)
                p_baja = st.slider("% Mover de PUNTA a BAJA", 0, 100, 10)

            with cs2:
                v_punta = st.number_input("Precio kWh Punta ($)", value=780.0)
                v_media = st.number_input("Precio kWh Media ($)", value=610.0)
                v_baja = st.number_input("Precio kWh Baja ($)", value=490.0)

            # C√°lculo de Ahorro
            # Identificamos energ√≠a en tarifa punta (ajustar string seg√∫n CSV)
            kwh_punta = df_filtered[df_filtered[mapping['TARIFA']].str.contains('MAX|PUNTA', na=False, case=False)]['kWh'].sum()

            ahorro_m = (kwh_punta * (p_media/100)) * (v_punta - v_media)
            ahorro_b = (kwh_punta * (p_baja/100)) * (v_punta - v_baja)
            total_ahorro = ahorro_m + ahorro_b

            st.metric("Ahorro Potencial Total", f"${total_ahorro:,.2f}", delta="Optimizado")

            if st.button("üß† Generar Consultor√≠a con IA"):
                with st.spinner("Analizando patrones de consumo con IA..."):
                    contexto = f"Empresa: {sede_sel}. Consumo total: {df_filtered['kWh'].sum()}. Ahorro estimado: {total_ahorro}. Tarifa predominante: {df_filtered[mapping['TARIFA']].mode()[0]}"
                    prompt = f"Como consultor energ√©tico experto, analiza estos datos y genera 3 recomendaciones estrat√©gicas y una conclusi√≥n sobre el ahorro de ${total_ahorro}: {contexto}"
                    st.session_state.ia_analysis = call_gemini_ai(prompt)
                    st.success("An√°lisis completado")

        with t4:
            st.subheader("Informe Ejecutivo para Cliente")
            if "ia_analysis" not in st.session_state:
                st.session_state.ia_analysis = "Ejecute el simulador de IA para obtener conclusiones."

            # Estructura del Informe HTML para PDF
            report_html = f"""
            <div class="report-container">
                <h1 style="color:#1e40af;">REPORTE DE EFICIENCIA ENERG√âTICA</h1>
                <p><b>Cliente:</b> {sede_sel if sede_sel != 'Todas' else 'Consolidado General'}</p>
                <hr>
                <h3>Resumen de Consumo</h3>
                <ul>
                    <li>Energ√≠a Total: {df_filtered['kWh'].sum():,.2f} kWh</li>
                    <li>Costo Actual Est.: ${df_filtered['Costo_Val'].sum():,.2f}</li>
                </ul>
                <h3>An√°lisis de Estrategia (IA)</h3>
                <p style="background-color: #f8fafc; padding: 15px; border-radius: 5px; border: 1px solid #e2e8f0;">
                    {st.session_state.ia_analysis}
                </p>
                <br>
                <p style="text-align:center; color: gray;">Generado por Energy Consultant Pro - {pd.Timestamp.now().strftime('%Y-%m-%d')}</p>
            </div>
            """
            st.markdown(report_html, unsafe_allow_html=True)
            st.button("Descargar Informe (Presione Ctrl+P y Guardar como PDF)")

    else:
        st.info("Esperando carga de datos por parte del Administrador para iniciar el an√°lisis.")