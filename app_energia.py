# -*- coding: utf-8 -*-
"""Aplicaci√≥n de Consultor√≠a Energ√©tica Avanzada

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1hZJUblT-w-UIo2RAv5rofkfNvjcqG2CR
"""

import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
import numpy as np
from datetime import datetime

# --- CONFIGURACI√ìN DE P√ÅGINA ---
st.set_page_config(
    page_title="Consultor√≠a Energ√©tica Expert BI",
    page_icon="‚ö°",
    layout="wide",
)

# --- ESTILOS DE INGENIER√çA Y PRINT CSS ---
st.markdown("""
    <style>
    @media print {
        .stButton, .stDownloadButton, .no-print, [data-testid="stSidebar"], .stTabs [role="tablist"] {
            display: none !important;
        }
        .report-container {
            border: none !important; box-shadow: none !important;
            padding: 0 !important; width: 100% !important;
        }
        .stPlotlyChart { page-break-inside: avoid !important; }
    }
    .report-container {
        background-color: white; padding: 50px; border-radius: 15px;
        border: 1px solid #e2e8f0; box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        max-width: 1100px; margin: auto; color: #1e293b;
    }
    .prompt-box {
        background-color: #0f172a; color: #38bdf8; padding: 25px;
        border-radius: 10px; font-family: 'Consolas', monospace;
        font-size: 0.9em; border: 1px solid #334155; line-height: 1.5;
    }
    .metric-card {
        background: #f8fafc; border: 1px solid #cbd5e1;
        padding: 15px; border-radius: 8px; text-align: center;
    }
    .saving-card {
        background: #ecfdf5; border: 1px solid #10b981;
        padding: 15px; border-radius: 8px; color: #065f46;
    }
    </style>
""", unsafe_allow_html=True)

# --- CONSTANTES ---
DIAS_ORDENADOS = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo']
MESES_ORDENADOS = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre']

# --- PROCESAMIENTO T√âCNICO ---
@st.cache_data
def procesar_archivo_v8(uploaded_file):
    try:
        if uploaded_file.name.endswith('.csv'):
            uploaded_file.seek(0)
            df = pd.read_csv(uploaded_file, sep=None, engine='python', encoding='latin-1')
        else:
            try: df = pd.read_excel(uploaded_file, sheet_name="TABLA HORARIA")
            except: df = pd.read_excel(uploaded_file)

        df.columns = df.columns.astype(str).str.strip()

        c_fecha = next((c for c in df.columns if c.upper() == 'FECHA'), None)
        c_hora = next((c for c in df.columns if c.upper() == 'HORA'), None)
        c_energia = next((c for c in df.columns if 'ENERGIA' in c.upper()), None)
        c_val_unit = next((c for c in df.columns if 'VALOR KWH' in c.upper() or 'VALOR Kwh' in c.upper()), None)
        c_val_total = next((c for c in df.columns if 'VALOR CONSUMO' in c.upper()), None)
        c_sede = next((c for c in df.columns if c.upper() == 'NOMBRE'), None)
        c_tarifa = next((c for c in df.columns if c.upper() == 'TARIFA'), None)

        if c_fecha and c_hora:
            df['fecha_dt'] = pd.to_datetime(df[c_fecha], dayfirst=True, errors='coerce', format='mixed')
            df['hora_clean'] = df[c_hora].astype(str).str.replace('p. m.', 'PM', case=False).str.replace('a. m.', 'AM', case=False).str.strip()
            temp_time = pd.to_datetime(df['hora_clean'], format='%I:%M:%S %p', errors='coerce')
            df['hora_num'] = temp_time.dt.hour

            if df['hora_num'].isnull().all():
                df['hora_num'] = df[c_hora].astype(str).str.extract('(\d+)').astype(float).fillna(0).astype(int)

            def clean_numeric(x):
                if isinstance(x, str):
                    x = x.replace('$', '').replace('.', '').replace(',', '.').strip()
                return pd.to_numeric(x, errors='coerce')

            df['kwh'] = df[c_energia].apply(clean_numeric).fillna(0)
            df['precio_kwh'] = df[c_val_unit].apply(clean_numeric).fillna(0) if c_val_unit else 0
            df['costo_total'] = df[c_val_total].apply(clean_numeric).fillna(0) if c_val_total else 0

            df['tarifa_label'] = df[c_tarifa].astype(str).str.upper() if c_tarifa else "UNICA"
            df['dia_nombre'] = df['fecha_dt'].dt.day_name().map({'Monday':'Lunes','Tuesday':'Martes','Wednesday':'Mi√©rcoles','Thursday':'Jueves','Friday':'Viernes','Saturday':'S√°bado','Sunday':'Domingo'})
            df['mes_nombre'] = df['fecha_dt'].dt.month_name().map({'January':'Enero','February':'Febrero','March':'Marzo','April':'Abril','May':'Mayo','June':'Junio','July':'Julio','August':'Agosto','September':'Septiembre','October':'Octubre','November':'Noviembre','December':'Diciembre'})
            df['sede_label'] = df[c_sede] if c_sede else "Sede General"

            return df.dropna(subset=['fecha_dt'])
        return None
    except Exception as e:
        st.error(f"Error t√©cnico: {e}")
        return None

# --- UI ---
if "auth" not in st.session_state: st.session_state.auth = False

if not st.session_state.auth:
    st.title("üõ°Ô∏è Portal de Auditor√≠a Energ√©tica v8.0")
    u, p = st.text_input("Ingeniero"), st.text_input("Clave", type="password")
    if st.button("Ingresar"):
        if u == "admin" and p == "admin123":
            st.session_state.auth = True
            st.rerun()
else:
    # Sidebar
    st.sidebar.title("üè¢ Configuraci√≥n")
    cons_empresa = st.sidebar.text_input("Consultora", "Expert BI Solutions")
    cons_nombre = st.sidebar.text_input("Auditor", "Ing. Senior")
    cliente = st.sidebar.text_input("Cliente", "MANUFACTURAS ELIOT")
    fecha_inf = st.sidebar.date_input("Fecha", datetime.now())
    logo = st.sidebar.file_uploader("Logo", type=["png", "jpg"])

    file = st.sidebar.file_uploader("Telemetr√≠a (CSV/Excel)", type=["csv", "xlsx"])
    if file:
        d = procesar_archivo_v8(file)
        if d is not None: st.session_state.master = d

    if "master" in st.session_state:
        df = st.session_state.master
        puntos = ["Todos"] + sorted(df['sede_label'].unique().tolist())
        punto_sel = st.sidebar.selectbox("Punto de Medici√≥n", puntos)
        dfv = df if punto_sel == "Todos" else df[df['sede_label'] == punto_sel]

        # --- CALCULOS AVANZADOS ---
        perfil_h = dfv.groupby('hora_num')['kwh'].mean().reset_index()
        total_kwh = dfv['kwh'].sum()
        pico_max = dfv['kwh'].max()
        val_kwh_avg = dfv[dfv['precio_kwh'] > 0]['precio_kwh'].mean()
        costo_proyectado = total_kwh * val_kwh_avg if val_kwh_avg > 0 else dfv['costo_total'].sum()

        # BASELOAD MEJORADA (Promedio de m√≠nimos reales > 0)
        reales = dfv[dfv['kwh'] > 0]
        if not reales.empty:
            min_diarios = reales.groupby('fecha_dt')['kwh'].min()
            baseload_avg = min_diarios.mean()
            baseload_min = reales['kwh'].min()
        else:
            baseload_avg = 0
            baseload_min = 0

        load_factor = (total_kwh / (pico_max * len(dfv))) if pico_max > 0 else 0

        tabs = st.tabs(["üìâ Dashboard", "üî• Mapas de Calor", "üîã Baseload", "üí∞ Proyecci√≥n de Ahorro", "üé® Graficador Pro", "üß† IA Auditor", "üìÑ Informe"])

        with tabs[0]:
            st.subheader(f"Resumen Operativo: {punto_sel}")
            k1, k2, k3, k4 = st.columns(4)
            k1.metric("Energ√≠a Total", f"{total_kwh:,.0f} kWh")
            k2.metric("Pico Demanda", f"{pico_max:,.2f} kW")
            k3.metric("Factor de Carga", f"{load_factor:.2f}")
            k4.metric("Precio Promedio", f"${val_kwh_avg:,.2f}/kWh")

            c1, c2 = st.columns(2)
            fig1 = px.line(perfil_h, x='hora_num', y='kwh', title="Curva de Carga Promedio (kW)", markers=True, labels={'kwh': 'Demanda (kW)', 'hora_num': 'Hora'})
            c1.plotly_chart(fig1, use_container_width=True, key="dash1")
            fig2 = px.box(dfv, x='dia_nombre', y='kwh', title="Estabilidad por D√≠a", category_orders={'dia_nombre': DIAS_ORDENADOS}, labels={'kwh': 'kW'})
            c2.plotly_chart(fig2, use_container_width=True, key="dash2")

        with tabs[1]:
            st.subheader("An√°lisis Geom√©trico de Intensidad")
            ch1, ch2 = st.columns(2)
            h1 = dfv.groupby(['dia_nombre', 'hora_num'])['kwh'].mean().reset_index()
            h1_p = h1.pivot(index='hora_num', columns='dia_nombre', values='kwh')
            fig_h1 = px.imshow(h1_p[[d for d in DIAS_ORDENADOS if d in h1_p.columns]], color_continuous_scale='RdYlGn_r', title="Heatmap: Hora vs D√≠a")
            ch1.plotly_chart(fig_h1, use_container_width=True, key="heat1")

            h2 = dfv.groupby(['mes_nombre', 'dia_nombre'])['kwh'].sum().reset_index()
            h2_p = h2.pivot(index='mes_nombre', columns='dia_nombre', values='kwh')
            fig_h2 = px.imshow(h2_p.loc[[m for m in MESES_ORDENADOS if m in h2_p.index], [d for d in DIAS_ORDENADOS if d in h2_p.columns]], title="Heatmap: Mes vs D√≠a")
            ch2.plotly_chart(fig_h2, use_container_width=True, key="heat2")

        with tabs[2]:
            st.subheader("Diagn√≥stico de Carga Base (Baseload)")
            st.info(f"Consumo pasivo promedio detectado: **{baseload_avg:,.2f} kW**")
            fig_base = go.Figure()
            fig_base.add_trace(go.Scatter(x=perfil_h['hora_num'], y=perfil_h['kwh'], name="Promedio", fill='tozeroy'))
            fig_base.add_trace(go.Scatter(x=perfil_h['hora_num'], y=[baseload_avg]*24, name="Umbral Baseload", line=dict(color='red', dash='dash')))
            st.plotly_chart(fig_base, use_container_width=True, key="base_v")

        with tabs[3]:
            st.subheader("Simulador de Ahorros por Eficiencia")
            st.write("Ajuste los par√°metros para proyectar el ahorro mensual.")
            s1, s2 = st.columns(2)
            red_pico = s1.slider("% Reducci√≥n de Picos (Peak Shaving)", 0, 30, 10)
            red_base = s2.slider("% Optimizaci√≥n de Baseload", 0, 50, 15)

            # C√°lculo de ahorro
            ahorro_pico_kwh = (pico_max * (red_pico/100)) * 22 * 4 # Aprox 4 horas pico/d√≠a, 22 d√≠as mes
            ahorro_base_kwh = (baseload_avg * (red_base/100)) * 24 * 30
            ahorro_total_kwh = ahorro_pico_kwh + ahorro_base_kwh
            ahorro_moneda = ahorro_total_kwh * val_kwh_avg

            st.markdown(f"""
            <div class='saving-card'>
                <h4>Proyecci√≥n Mensual de Ahorro Estimado</h4>
                <p style='font-size:24px; margin:0;'><b>${ahorro_moneda:,.2f} USD/COP</b></p>
                <p>Equivalente a una reducci√≥n de <b>{ahorro_total_kwh:,.0f} kWh/mes</b></p>
            </div>
            """, unsafe_allow_html=True)

        with tabs[4]:
            st.subheader("üé® Graficador Pro")
            cg1, cg2, cg3 = st.columns(3)
            col_x = cg1.selectbox("Eje X", ['hora_num', 'dia_nombre', 'mes_nombre', 'tarifa_label'])
            col_y = cg2.selectbox("Eje Y", ['kwh', 'precio_kwh', 'costo_total'])
            tipo_g = cg3.radio("Estilo", ['Barras', 'L√≠neas', 'Dispersi√≥n'])
            if tipo_g == 'Barras': fig_c = px.bar(dfv, x=col_x, y=col_y, color='tarifa_label')
            elif tipo_g == 'L√≠neas': fig_c = px.line(dfv, x=col_x, y=col_y, color='tarifa_label')
            else: fig_c = px.scatter(dfv, x=col_x, y=col_y, color='tarifa_label')
            st.plotly_chart(fig_c, use_container_width=True)

        with tabs[5]:
            st.subheader("Consultor√≠a IA Senior")
            t_res = dfv.groupby('tarifa_label')['kwh'].agg(['sum', 'mean']).reset_index()
            tarifas_str = "; ".join([f"{r['tarifa_label']} (${val_kwh_avg:,.1f}/kWh promedio)" for _, r in t_res.iterrows()])

            prompt = f"""
            Rol: Consultor Senior de Eficiencia Energ√©tica.
            Empresa: {cliente} | Sede: {punto_sel}.
            Datos: Energ√≠a {total_kwh:,.0f} kWh, Pico {pico_max:,.2f} kW, Baseload {baseload_avg:,.2f} kW, Factor Carga {load_factor:.2f}.
            Tarifas Detectadas: {tarifas_str}.

            Solicitud:
            1. Analiza si el precio promedio de ${val_kwh_avg:,.2f} est√° dentro de los rangos competitivos del mercado industrial actual.
            2. Eval√∫a si el Baseload ({baseload_avg:,.2f} kW) representa una oportunidad de mejora significativa.
            3. Determina si el perfil de carga es 'plano' o 'puntiagudo' y qu√© tecnolog√≠a (Bater√≠as, Solar, Gesti√≥n de demanda) es m√°s rentable.
            4. Realiza un an√°lisis cr√≠tico sobre la tarifa actual: ¬øEst√° el cliente en la tarifa correcta seg√∫n su perfil horario?
            """
            st.markdown(f'<div class="prompt-box">{prompt}</div>', unsafe_allow_html=True)

        with tabs[6]:
            st.subheader("Informe Profesional")
            st.button("üñ®Ô∏è Generar PDF", on_click=lambda: st.write("<script>window.print();</script>", unsafe_allow_html=True))

            st.markdown('<div class="report-container">', unsafe_allow_html=True)
            col_l, col_r = st.columns([1, 2])
            with col_l:
                if logo: st.image(logo, width=150)
                else: st.markdown(f"### {cons_empresa}")
            with col_r:
                st.markdown(f"<h1 style='text-align:right; margin:0;'>INFORME T√âCNICO ENERG√âTICO</h1>", unsafe_allow_html=True)
                st.markdown(f"<p style='text-align:right; color:#64748b;'><b>Auditor:</b> {cons_nombre}<br><b>Fecha:</b> {fecha_inf.strftime('%d/%m/%Y')}</p>", unsafe_allow_html=True)

            st.divider()
            st.markdown(f"## 1. Resumen Ejecutivo: {cliente}")
            st.write(f"Se ha realizado un an√°lisis exhaustivo del punto de medici√≥n **{punto_sel}**. Los indicadores muestran una demanda pico de **{pico_max:,.2f} kW**.")

            st.markdown("### 2. KPIs de Auditor√≠a")
            st.columns(3)[0].markdown(f"<div class='metric-card'><b>ENERG√çA TOTAL</b><br>{total_kwh:,.0f} kWh</div>", unsafe_allow_html=True)
            st.columns(3)[1].markdown(f"<div class='metric-card'><b>BASELOAD REAL</b><br>{baseload_avg:,.2f} kW</div>", unsafe_allow_html=True)
            st.columns(3)[2].markdown(f"<div class='metric-card'><b>COSTO kWh PROMEDIO</b><br>${val_kwh_avg:,.2f}</div>", unsafe_allow_html=True)

            st.markdown("### 3. Visualizaciones T√©cnicas")
            st.plotly_chart(fig1, use_container_width=True, key="rep1")
            st.plotly_chart(fig_h1, use_container_width=True, key="rep2")
            st.plotly_chart(fig2, use_container_width=True, key="rep3")

            st.markdown("### 4. Proyecci√≥n de Ahorros")
            st.write(f"Mediante la implementaci√≥n de estrategias de Peak Shaving ({red_pico}%) y optimizaci√≥n de Baseload ({red_base}%), se proyecta un ahorro de:")
            st.markdown(f"<div class='saving-card' style='text-align:center'><b>Ahorro Proyectado: ${ahorro_moneda:,.2f} / Mes</b></div>", unsafe_allow_html=True)

            st.markdown("### 5. An√°lisis de Tarifas")
            st.table(t_res.rename(columns={'tarifa_label': 'Tarifa', 'sum': 'Consumo (kWh)', 'mean': 'Promedio (kW)'}))

            st.markdown(f"<br><br><br><p style='border-top: 1px solid #000; width: 300px;'><b>{cons_nombre}</b><br>{cons_empresa}</p>", unsafe_allow_html=True)
            st.markdown('</div>', unsafe_allow_html=True)

    else:
        st.info("üëã Bienvenida, Ingeniero. Por favor cargue el archivo de telemetr√≠a.")